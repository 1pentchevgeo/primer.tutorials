---
title: "Three Parameters A"
tutorial:
  id: "three-parameters-a"
output:
  learnr::tutorial:
      progressive: true
      allow_skip: true
runtime: shiny_prerendered
description: "Chapter 8 tutorial"
---

```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(primer.data)
library(rstanarm)
knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 

fit_1 <- stan_glm(age ~ party - 1, 
                    data = trains, 
                    seed = 17,
                    refresh = 0)

pp <- posterior_predict(..., newdata = ...) %>% 
  as_tibble() %>% 
  mutate_all(as.numeric)

```

```{r copy-code-chunk, child = "../../child_documents/copy_button.Rmd"}
```

```{r info-section, child = "../../child_documents/info_section.Rmd"}
```


<!-- CHECKLIST BEFORE STARTING: -->
<!-- * Load necessary libraries for tutorial in the first code chunk -->
<!-- * Edit yaml at the START OF THIS FILE -->
<!-- * Review: https://ppbds.github.io/primer.tutorials/articles/instructions.html -->


<!-- ## First section (use sentence case) -->
<!-- ### -->


<!-- Move all material from a to b. -->

<!-- Make the tutorial follow the chapter very closely: section by section. -->

<!-- Use our new skeletons.  -->

<!-- Change text questions to allow for written answers, and then provide your own perfect written answders. -->

## Wisdom

Our first step when considering our cardinal virtues is wisdom. This pertains to considering the questions we strive to answer and the population for which we would like to answer them for, while also recognizing the data we would ideally have as compared to what we do.

Let's say we are trying to answer the following questions about train commuters:

1. *What is the expected age of a Democrat at the train station?*

2. *In a group of three Democrats and three Republicans, what will the age difference be between the oldest Democrat and the youngest Republican?* 

3. *What is the average treatment effect, of exposing people to Spanish-speakers, on their attitudes toward immigration?* 

4. *What is the largest causal effect on immigration attitudes due to exposing people to Spanish-speakers which still has a 1 in 10 chance of occurring?*

5. *What would you expect the income to be for a random 40 year old?*

6. *Among all people who have an income $100,000, what proportion are liberal?*

7. *Assume we have a group of eight people, two of whom make $100,000, two $200,000, two $300,000 and two $400,000. How many will be liberal?*

### Exercise 1

In order to answer the first two questions, what type of data would we like to have in our preceptor table. Consider the type of model and the outcome variable. 


```{r wisdom-ex-1}
question_text(NULL,
	message = "We would use a predictive model and would ideally have data on both the political affiliation and age of train commuters. Our outcome variable would be age.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 2

Next consider the third and fourth question and the data needed in the preceptor table to answer them.

```{r wisdom-ex-2}
question_text(NULL,
	message = "These questions would need a causal model with a column for the immigration attitudes for someone who was not exposed to spanish-speakers and for someone who wasn't. The outcome variable would be the difference between the treatment value and the control value.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 3

Continue this process for questions 5-7.

```{r wisdom-ex-3}
question_text(NULL,
	message = "For question 5, we would use a predictive model. The data we would need would be age and income, and income would be the outcome variable. For questions 6 and 7, we would also use a predictive model, but income and whether someone is liberal or not would be the necessary data to answer the question, with the quality of being liberal or not as the outcome variable.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### 

In the past three exercises, we have executed the first step of wisdom, in considering the questions and figuring out ideally what data we would have to answer them. In doing so, we have determined the columns of our Preceptor table, those being age, political party, immigration attitude for those who were exposed to Spanish speakers and for those who weren't, as well as income, and being liberal or not. 

### Exercise 4

Next, let's take a look at the dataset we would like to use to answer these questions. We will be using `trains`. First, let's take a look at trains through the glimpse method.
```{r wisdom-ex-4, exercise = TRUE}

```

```{r wisdom-ex-4-hint, eval = FALSE}
glimpse(trains)
```

###

Take a look at the variables and their types. 

### Exercise 5

Next, learn more about the dataset by calling '?trains'. 

```{r wisdom-ex-5, exercise = TRUE}

```

```{r wisdom-ex-5-hint, eval = FALSE}
?trains
```

### Exercise 6

Now, with a greater understanding of the data, determine if you have enough data to answer all the questions, and if not, which questions can you answer, and what columns from 'trains' will be of value to you to do so. Recall our Preceptor table.

```{r wisdom-ex-6}
question_text(NULL,
	message = "We can answer every question since we have the data to do so. We will need the columns of age, income, party, liberal, att_end and treatment. This is because we need to know the age, income, political party, and whether or not someone is liberal. Additionally, att_end is the individual's ending attitude on immigration and treatment is whether or not the individual was exposed to Spanish-speakers.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 7

Recall that this study was done in Boston, MA in 2012. Discuss whether you believe this data is drawn from and can be applied to our population of general train commuters today. 

```{r wisdom-ex-7}
question_text(
  '',
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Text for button",
	incorrect = NULL)
```

###

While you may or may not believe that the data can be applied to our population, it is necessary to discuss how the populations may be similar and different in order to determine whether we can continue. 

For our purposes, we will assume that the data is drawn from the same population and can be applied to our population. 

###

We have now completed wisdom by creating our Preceptor Table and analyzing our data and determining its application to our questions and our population. 

## age ~ party

Now that we have completed Wisdom for all of our questions, let's look at the ones dealing specifically with the relation between age and party.

*What is the expected age of a Democrat at the train station?*

*In a group of three Democrats and three Republicans, what will the age difference be between the oldest Democrat and the youngest Republican?* 

<!-- MM: Insert questions about representativeness and validity -->

### Exercise 1

For each relationship, we must consider the representativeness and validity of the data with regards to the specific data we are looking at. For representativeness, discuss whether or not you believe that specifically age and party affiliation from this data set can be applied to our current population. Be sure to consider how the groups may be similar and different.

```{r age--party-ex-1}
question_text(NULL,
	message = "While your belief may agree or disagree, you should take into account the how you think that age distribution and party affiliation distributions may have changed over time.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 2

After thoroughly considering how the data is representative of our population, we must then consider the validity for age and party affiliation. Discuss how valid age and party from this data set are in terms of our population. Has the meaning of being a Democrat or a Republican changed overtime? Ask yourself the same thing with age to answer this question.

```{r age--party-ex-2}
question_text(
	"prompt here",
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Text for button",
	incorrect = NULL)
```

Through the past two steps, we have completed the steps of Justice.

### Exercise 3

Now, let's make our posterior distribution using 'stan_glm()'. Set your outcome variable as `age`and your explanatory variable as `party` (Remember you must insert a tilde `~` between the two). Also, include a `-1` after `liberal` so we do not get an intercept.  Set `data` to `trains`, and `refresh` to 0 

```{r age--party-ex-3, exercise = TRUE}

```

```{r age--party-ex-3-hint, eval = FALSE}
stan_glm(age ~ party - 1, 
                    data = ...,
                    refresh = ..)
```

### Exercise 4

Store the above in a variable called `fit_1` and print it out. 

```{r age--party-ex-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-4-hint, eval = FALSE}
fit_1 <- ...
```

### Exercise 5

Now let's display this information graphically. First, let's make this into a tibble and remove `sigma` since it is not of relevance to us. Remember that we need to use `as_tibble()`.

```{r age--party-ex-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-5-hint, eval = FALSE}
fit_1 %>% 
  as_tibble() %>% 
  select(- sigma)
```

### Exercise 6

Now, let's change the labels of 'partyDemocrat' and 'partyRepublican' to be 'Democrat' and 'Republican' respectively. Print the tibble.

```{r age--party-ex-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-6-hint, eval = FALSE}
... %>% 
  mutate(Democrat = partyDemocrat, Republican, partyRepublican)
```

### Exercise 7

Next, let's make the tibble longer with the rows Democrat and Republican. Remember to set `names_to` to "parameter" and `values_to` to "age".

```{r age--party-ex-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-7-hint, eval = FALSE}
... %>% 
pivot_longer(cols = ...,
             names_to = ...
             values_to = ...)
```

### Exercise 8

Next, let's plot this. Put `age` on the x-axis and `parameter` to fill. Then use `geom_histogram()`.

```{r age--party-ex-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-8-hint, eval = FALSE}
... %>% 
  ggplot(aes(x = ..., fill = ...)) %>% 
  geom_histogram()
```

### Exercise 9

Now convert the y-axis to be a probability by using `aes()` in the first parameter of `geom_histogram()`. Additionally, set `alpha` to 0.5, `bins` to 100, and `position` to "identity".

```{r age--party-ex-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-9-hint, eval = FALSE}
... geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5,
                   bins = 100,
                   position = "identity")
```

### Exercise 10

Now, add labels and change the scale on the y-value to make it into a percent format. Also add `theme_classic()`. 

The graph should look something like the following:

```{r age--party-sample-graph, echo = FALSE}
fit_1 %>% 
  as_tibble() %>% 
  select(-sigma) %>% 
  mutate(Democrat = partyDemocrat, Republican = partyRepublican) %>%
  pivot_longer(cols = Democrat:Republican,
               names_to = "parameter",
               values_to = "age") %>% 
  ggplot(aes(x = age, fill = parameter)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
    labs(title = "Posterior for Average Age",
         subtitle = "More data allows for a more precise posterior for Democrats",
         x = "Age",
         y = "Probability") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_classic()
```


```{r age--party-ex-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-10-hint-1, eval = FALSE}
To change the label, you can use `scale_y_continuous`
```

```{r age--party-ex-10-hint-2, eval = FALSE}
... %>% 
  labs(title = ...,
       subtitle = ...,
       x = ...,
       y = ...) %>% 
  scale_y_continuous(labels = scales::percent_format()) + 
  theme_classic()
```

###

You have now created the posterior probability distribution for average age in relation to each party. Using this, we can answer the questions we began with pertaining to the relationship between age and party affiliation of train commuters.

This brings us to the Temperance virtue for our model of `age~party`. 

### Exercise 11

Let's start by recalling the first question.

*What is the probability that if a Democrat shows up to the train station, he will be over 50 years old?*

Using our fitted data, we can now attempt to answer this question.

In order to do so, first make a new tibble with one observation of the variable party and the value of the "Democrat". Set this equal to `new_obs`.

```{r age--party-ex-11, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-11-hint, eval = FALSE}
new_obs <- tibble(party = ...)
```

### Exercise 12

Next, let's use `posterior_predict()` to create draws from the posterior. Set the first argument to the model for which we are running our simulations, `fit_1`, and the second argument to `new_obs`. Additionally, make all of the columns into numeric vectors. Store this as `pp`.

```{r age--party-ex-12, exercise = TRUE}

```

```{r age--party-ex-12-hint-1, eval = FALSE}
Remember to use as_tibble() to convert the result to a tibble as well as mutate() to change the results to numbers.
```

```{r age--party-ex-12-hint-2, eval = FALSE}
pp <- posterior_predict(..., newdata = ...) %>% 
  as_tibble() %>% 
  mutate_all(as.numeric)
```

### Exercise 13

Now, let's plot this posterior. Plot the column representing age to the x-axis. Then use geom_histogram and use `aes()` in as the first argument to make the y-axiz represent the probability. Additionally, set `bins` to 100.

```{r age--party-ex-13, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-13-hint-1, eval = FALSE}
Remember that columns aren't named, so since age is in the first column, the x argument would need to be set at `1`. 
```

```{r age--party-ex-13-hint-2, eval = FALSE}
pp %>% 
  ggplot(aes(x = `1`)) +
  geom_histogram(aes(y = after_stat(count/sum(count))),
                bins = 100)
```

### Exercise 14

Now, add a labels, make the scale for the y-values into percent-format, and add `theme_classic()`.

```{r age--party-ex-14, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-14-hint, eval = FALSE}
... +
  labs(title = "...",
       subtitle = "...",
       x = "...",
       y = "...") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_classic()
```

Now that we have the posterior distribution, we can determine the probability the next Democrat will be over 50. 

### Exercise 15

In order to do so, use the posterior distribution and sum up the values in which the age is greater than 50. Then divide this value by the number of rows there are.

```{r age--party-ex-15, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-15-hint, eval = FALSE}
sum(pp$`1` > 50) / nrow(pp)
```

###

Therefore, the probability that the next Democrat will be over 50 is around 28%. 

<!-- MM: Change that answer so it isn't hardcoded -->

### Exercise 16

Next, let's consider the second question. 

*In a group of three Democrats and three Republicans, what will the age difference be between the oldest Democrat and the youngest Republican?*

Since our group has three Democrats and three Republicans, make a tibble with the observations of the column "party" that we desire. Store this as `new_obs`.


```{r age--party-ex-16, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-16-hint-1, eval = FALSE}
newobs <- tibble(party = c(...))
```

```{r age--party-ex-16-hint-1, eval = FALSE}
newobs <- tibble(party = c("Democrat", "Democrat", "Democrat", 
                           "Republican", "Republican","Republican"))
```

###

When doing this, ensure that the column names and the observations align with those of the original data set.

### Exercise 17

Now use posterior predict and make the values numeric vectors in order to create the posterior distribution. Remember to use our first argument as the fitted model `fit_1` we created earlier and the `newdata` equal to `newobs`.

```{r age--party-ex-17, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-17-hint, eval = FALSE}
posterior_predict(..., newdata = ...) %>%
    as_tibble() %>%
    mutate_all(as.numeric)
```

### Exercise 18

Currently your posterior predict has numbered columns correlating to the order in which we made the columns in `newobs`. Set the names to "dem_1", "dem_2", "dem_3", "rep_1", "rep_2", and "rep_3", respectively.

```{r age--party-ex-18, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-ex-18-hint-1, eval = FALSE}
Use the method set_names().
```

```{r age--party-ex-18-hint-1, eval = FALSE}
set_names(c(..., ..., ..., ..., ..., ...))
```

###



```{r download-answers, child = "../../child_documents/download_answers.Rmd"}
```
