---
title: Rubin Causal Model A
tutorial:
  id: rubin-causal-model-a
output:
  learnr::tutorial:
    progressive: yes
    allow_skip: yes
runtime: shiny_prerendered
description: Chapter 4 Tutorial
---

```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(gt)
library(knitr)

# Key Data 

gt_obj <- tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       treatment = c("Treated", "Treated", "Control", "Control", "Treated"), 
       ytreat = c("13", "14", "11", "9", "3"),
       ycontrol = c("9", "11", "6", "12", "4"),
       ydiff = c("? ", "? ", "? ", "? ", "? ")) %>%
   gt() %>%
  cols_label(subject = md("ID"),
                treatment = md("Treatment"),
                ytreat = md("$$Y_t(u)$$"),
                ycontrol = md("$$Y_c(u)$$"),
                ydiff = md("$$Y_t(u) - Y_c(u)$$")) %>%
  cols_move(columns = c(treatment, ytreat, ycontrol), after = c(subject)) %>%
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = c(subject))) %>%
  tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
            locations = cells_column_labels(columns = c(subject, treatment))) %>%
  cols_align(align = "center", columns = everything()) %>%
  cols_align(align = "left", columns = c(subject)) %>%
  fmt_markdown(columns = everything()) %>%
  tab_spanner(label = "$$\\text{Outcomes}$$", c(ytreat, ycontrol))  %>%
  tab_spanner(label = "$$\\text{Causal Effect}$$", c(ydiff))


knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 
```

<!-- Match this closely to the chapter because, someday, we are going to stick all of these questions in the chapter. Does not need to be 90 minutes of questions. -->

<!--  And fix the 2 taus table in the 2nd tutorial so that tau is easier to calculate mentally. --> 

<!-- How do we give students information about being wrong or right? Easy for code! -->

<!-- After the definitions, we could have some problems which use the actual train data, calculate some causal effects and then plot them. Lots of good staff there. First, assume a single tau. What is it? How sure are you? Then separate taus for men and women. Or some other grouping. Show facetted plot. -->

<!-- One question could take the trains data and make a Preceptor table. Learn a little gt! Would also need some manipulation to create the two potential outcome columns. -->

<!-- More about confounding. Of course, it needs to be in the book. -->



```{r copy-code-chunk, child = "../../child_documents/copy_button.Rmd"}
```

```{r info-section, child = "../../child_documents/info_section.Rmd"}
```

## Definitions

### 

If you have read the chapter, then these questions should be easy. Please note that you can not change your answers once you submit them. 

### Exercise 1

In your own words, give a one sentence definition of a Preceptor Table.

```{r definitions-1}
question_text(NULL,
    message = "A table (typically) with data missing, used to solve a problem/question.",
    answer(NULL, correct = TRUE),
    allow_retry = FALSE,
    incorrect = NULL,
    options = list(nrows = 3))
```

### Exercise 2

In your own words, give a one sentence definition of a potential outcome.

```{r definitions-2}
question_text(NULL,
    message = "An outcome of a situation (Ex. Losing $20 when gambling, or winning $20 dollars).",
    answer(NULL, correct = TRUE),
    allow_retry = FALSE,
    incorrect = NULL,
    options = list(nrows = 3))
```

### Exercise 3

In your own words, give a one sentence definition of a causal effect.

```{r definitions-3}
question_text(NULL,
    message = "The difference between two outcomes.",
    answer(NULL, correct = TRUE),
    allow_retry = FALSE,
    incorrect = NULL,
    options = list(nrows = 3))
```

### Exercise 4

Give a paragraph explanation about the Fundamental Problem of Causal Inference. Include an example relating to your own life.

```{r definitions-4}
question_text(NULL,
    message = "The Fundamental Problem of Causal Inference states that one possible outcome is always missing because you can not observe all potential outcomes at once. For example, imagine I have a math test tomorrow. I can choose between eating breakfast before the test, or not eating breakfast before the test. Let's say I choose outcome A, and I  eat the cereal. Since I can’t go back in time, I can only observe the result if I ate the cereal and can not observe the result of not eating cereal.",
    answer(NULL, correct = TRUE),
    allow_retry = FALSE,
    incorrect = NULL,
    options = list(nrows = 7))
```

### Exercise 5

In two sentences, explain what what an *ideal* Preceptor Table is, and why it is generally impossible to observe. Use the phrase "potential outcomes" in your answer. 

```{r definitions-5}
question_text(NULL,
    message = "An ideal Preceptor Table is a table that does not have any missing data. This table is seen as impossible to observe since it means that you can observe all potential outcomes of a situation, which is impossible due to the Fundamental Problem of Causal Inference.",
    answer(NULL, correct = TRUE),
    allow_retry = FALSE,
    incorrect = NULL,
    options = list(nrows = 5))
```

### Exercise 6

In one sentence, explain the difference between an *actual* Preceptor Table and an *ideal* Preceptor Table.

```{r definitions-6}
question_text(NULL,
    message = "An actual Preceptor Table has missing data, whereas an ideal Preceptor Table doesn’t have any missing data",
    answer(NULL, correct = TRUE),
    allow_retry = FALSE,
    incorrect = NULL,
    options = list(nrows = 3))
```




## Causal Effect

### 

Use the following ideal Preceptor Table to answer some questions about causal effect that we might be interested in.

```{r}
gt_obj
```


### Exercise 1
What is the causal effect of the treatment on Yao?

```{r causal-effect-13}
question_text(NULL,
	message = "His causal effect is 4. This is calculated by subtracting his $Y_t(u)$ from his $Y_t(c)$.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```



### Exercise 2
What is the median causal effect?

```{r causal-effect-ex-2}
question_text(NULL,
	message = "The median causal effect is 3.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```


## One tau

### 

In these exercises, we will assume that the causal effect, $\tau$ (pronounced tau), is the same for everyone.


Use the following actual Preceptor Table to answer questions about a single value for tau.

```{r question-singletau-setup}
tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       treatment = c("Treated", "Treated", "Control", "Control", "Treated"),
       ytreat = c("13", "14", "?", "?", "3"),
       ycontrol = c("?", "?", "6", "12", "?"),
       ydiff = c("?", "?", "?", "?", "?")) %>%
  gt() %>%
  cols_label(subject = md("ID"),
                treatment = md("Treatment"),
                ytreat = md("$$Y_t(u)$$"),
                ycontrol = md("$$Y_c(u)$$"),
                ydiff = md("$$Y_t(u) - Y_c(u)$$")) %>%
  cols_move(columns = c(treatment, ytreat, ycontrol), after = c(subject)) %>%
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = c(subject, treatment))) %>%
  tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
            locations = cells_column_labels(columns = c(subject))) %>%
  cols_align(align = "center", columns = everything()) %>%
  cols_align(align = "left", columns = c(subject)) %>%
  tab_spanner(label = "$$\\text{Outcomes}$$", c(ytreat, ycontrol)) %>%
  tab_spanner(label = "$$\\text{Causal Effect}$$", c(ydiff)) %>%
  fmt_markdown(columns = everything())
```

### Exercise 1

To calculate $\tau$, we use the formula $Y_t(u) - Y_c(u)$. How would you rearrange the formula look like to calculate $Y_c(u)$?
```{r one-tau-ex-1}
question_text(NULL,
	message = "$Y_c(u)$ = $Y_t(u)$ - tau",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### 

Once we have this formula, we need to find an estimate for $\tau$ to fill in missing values. This is done by subtracting the average of the observed control values from the average of the observed treated values. 

### Exercise 2

What is the average of the observed treated values ($Y_t(u)$)?
```{r one-tau-ex-2}
question_text(NULL,
	message = "The average is 10, calculated by adding 13, 14, and 3 then dividing by 3.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 3


What is the average of the observed control values ($Y_c(u)$)?
```{r one-tau-ex-3}
question_text(NULL,
	message = "The average is 9, calculated by adding 12 and 6 then dividing by 2.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```
###
Nice! After subtracting $Y_c(u)$ from $Y_t(u)$, we get our $\tau$ value. 

### Exercise 4

What is Tao's $Y_c(u)$ value?

```{r one-tau-ex-4}
question_text(NULL,
    message = "Tao's $Y_c(u)$ value is 12. This is calculated by finding that the value of tau is 1 (10 - 9 = 1), then subsituting $Y_t(u)$ and tau into the rearranged formula ($Y_c(u)$ = $Y_t(u)$ - $\tau$) to get $Y_c(u)$ = 13 - (+1), then solving.",
    answer(NULL, correct = TRUE),
    allow_retry = FALSE,
    incorrect = NULL,
    options = list(nrows = 2))
```

### Exercise 5

Describe in one sentence/equation how you would estimate Tahmids's $Y_t(u)$. (Do not use actual numbers, use "tau" in your explanation).

```{r one-tau-ex-5}
question_text(NULL,
    message = "Tau = (Sum of values in $Y_t(u)$ / Number of Values - Sum of values in $Y_c(u)$ / Number of values) + Tahmid's $Y_c(u)$",
    answer(NULL, correct = TRUE),
    allow_retry = FALSE,
    incorrect = NULL,
    options = list(nrows = 2))
```


### Exercise 6

what is your estimate for $Y_t(u)$ for Cassidy?
```{r one-tau-ex-6}
question_text(NULL,
	message = "$Y_t(u)$ for Cassidy is 7. (6 + 1 = 7)",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```


## Two taus

### 

<!-- Drop some knowledge! Remind what a Preceptor table. Set the stage. What is the experiment. -->

### 

Assume that the causal effect varies by sex. We will now estimate two values for $\tau$: $\tau_F$ and $\tau_M$. (Cassidy and Emma are female; Tahmid, Diego, and Yao are male).

```{r}
tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       treatment = c("Treated", "Treated", "Control", "Control", "Treated"),
       ytreat = c("13", "11", "$$6 + \\tau_F$$", "$$12 + \\tau_M$$", "3"),
       ycontrol = c("$$13 - \\tau_M$$", "$$14 - \\tau_F$$", "6", "12", "$$3 - \\tau_M$$"),
       ydiff = c("$$\\tau_M$$", "$$\\tau_F$$", "$$\\tau_F$$", "$$\\tau_M$$", "$$\\tau_M$$")) %>%
  gt() %>%
  cols_label(subject = md("ID"),
                treatment = md("Treatment"),
                ytreat = md("$$Y_t(u)$$"),
                ycontrol = md("$$Y_c(u)$$"),
                ydiff = md("$$Y_t(u) - Y_c(u)$$")) %>%
  cols_move(columns = c(ytreat, ycontrol), after = c(subject)) %>%
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = c(subject, treatment))) %>%
  tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
            locations = cells_column_labels(columns = c(subject))) %>%
  cols_align(align = "center", columns = everything()) %>%
  cols_align(align = "left", columns = c(subject)) %>%
  tab_spanner(label = "$$\\text{Outcomes}$$", c(ytreat, ycontrol)) %>%
  tab_spanner(label = "$$\\text{Causal Effect}$$", c(ydiff)) %>%
  fmt_markdown(columns = everything())
```

### Exercise 1

How would you calculate $\tau_F$? Use only words and no numbers in your explanation.

```{r two-taus-1}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 3))
```

### 

### Exercise 2

What is the meaning of $\tau_M$? 

```{r two-taus-2}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 1))
```

### 

### Exercise 3

What is your new estimate for Diego's $Y_c(u)$? 

```{r two-taus-3}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 1))
```

### Exercise 4

Discuss for a sentence or two why an assumption that the causal effect varies by sex leads to a different estimate for Diego's $Y_c(u)$ compared to Cassidy's $Y_c(u)$.

```{r two-taus-4}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 3))
```

### 

## Average Treatment Effect

### 

We will no longer make any assumptions about $\tau$ for any individual or group. Instead, we are interested in estimating the average treatment effect ($ATE). We have the same data as the previous sections.

```{r}
gt_obj
```

### Exercise 1

Using words only, explain how we estimate the $ATE$.

```{r average-treatment-ef-1}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 3))
```

<!-- Average of treated values minus the average of control values is the standard way of estimating the ATE. -->

### 

### Exercise 2

Estimate the $ATE$ based on the data given to you in the above Preceptor Table.

```{r average-treatment-ef-2}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 1))
```

### Exercise 3

What is Cassidy's outcome under treatment if we assume $\tau$ to be the $ATE$ we calculated above? Note that the answer will just be a number, without any symbol.

```{r average-treatment-ef-3}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 1))
```

### Exercise 4

Write a paragraph about the many, many reasons why $ATE$ may be a bad estimate of the true average treatment effect.

```{r average-treatment-ef-4}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 7))
```

### 

### Exercise 5

Write a paragraph about what a heterogeneous treatment effect is and the situations when it is more or less common.

```{r average-treatment-ef-5}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 7))
```

### 

## Causal vs Predictive Models 

### 

### Exercise 1

Write two sentences that explain the difference between a causal model and a predictive model. 

```{r causal-vs-predictive-1}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 7))
```

### 

```{r download-answers, child = "../../child_documents/download_answers.Rmd"}
```
