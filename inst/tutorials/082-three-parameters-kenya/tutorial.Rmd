---
title: "Three Parameters: Kenya"
author: Mahima Malhotra
tutorial:
  id: three-parameters-kenya
output:
  learnr::tutorial:
    progressive: yes
    allow_skip: yes
runtime: shiny_prerendered
description: Use data from Kenya voter registration efforts to construct a three parameter model.
---

```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(primer.data)
library(rstanarm)
library(gt)

knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 

```

```{r copy-code-chunk, child = "../../child_documents/copy_button.Rmd"}
```

```{r info-section, child = "../../child_documents/info_section.Rmd"}
```

<!-- Let's make our own data set. Start with a primer.data data set. Filter our some of the rows in a way that messes things up in the same way that filtering our living candidates messes up go governors. -->

<!-- Example from kenya is that if you want to estimate poverty ~ 1, you get an unbiased estimate if you use the whole data set. But if you restrit to just polling stations within 25 km, you get a biased model becuause polling stations farther away are poorer. But this example is no good because we need three parameters.-->

<!-- So, find a simple linear model, like poverty ~ age, or distance ~ pop_density, or mean_age ~ distance, rv_12 ~ poverty. Good if the model works, meaningful relationship. Don't use treatment or reg_byrv13. Then, we modify the sample, in some way, by removing a bunch of rows in a non-crazy way which does not use the two variables in our model. But, we want a fun story to tell! There must be a biased which the non-reprsentative nature of our sample creates. In other words, the coefficient to be (very?) different between using all the data and using the reduced sample. -->

<!-- Four different ways to mess up representative data. First, remove rows on the basis of a variable which is not in your model. Second, remove rows on the basis of an independent variable in the model. Third, remove rows on the basis of the dependent variable. Four, remove rows on the basis of potential outcomes.  -->

<!-- Tell the story of experimenters who got lazy (or scared) and did not want to travel too far, and so your data only has 1188.  -->

<!-- Try kenya. Feel free to simplify by, for example, only keeping around two treatments: control and something else.  -->

## fitted models and graphs

```{r}
kenya_1 <- kenya %>% 
  filter(treatment %in% c("canvass", "control"))
  

kenya_1

kenya_2 <- kenya_1 %>% 
  filter(distance < 25)
```

```{r}
fit_1 <- stan_glm(distance ~ poverty,
                  data = kenya_1,
                  refresh = 0)

fit_1

newobs1 <- tibble(poverty = 0.2)

pp <- posterior_epred(fit_1, newdata = newobs1) %>% 
  as_tibble()

exp_poverty <- pp %>%
  ggplot(aes(x = `1`)) + 
  geom_histogram(aes(y = after_stat(count/sum(count))),
                 bins = 100) +
  labs(title = "Posterior for Expected Distance",
       subtitle = "Polling locations about 13 miles away on average from those assigned to them have poverty rates of 0.2",
       x = "Poverty Rate",
       y = "Probability") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_classic()
  

exp_poverty
```

```{r}
fit_2 <- stan_glm(distance ~ poverty,
                  data = kenya_2,
                  refresh = 0)

fit_2

newobs2 <- tibble(poverty = 0.2)

pp <- posterior_epred(fit_2, newdata = newobs2) %>% 
  as_tibble()

exp_poverty_2 <- pp %>%
  ggplot(aes(x = `1`)) + 
  geom_histogram(aes(y = after_stat(count/sum(count))),
                 bins = 100) +
  labs(title = "Posterior for Expected Distance",
       subtitle = "Polling locations about 11 miles away on average from those assigned to them have poverty rates of 0.2",
       x = "Poverty Rate",
       y = "Probability") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_classic()
  
exp_poverty_2
```

```{r}
newobs3 <- tibble(poverty = c(0.5, 0.8))

pp <- posterior_predict(fit_1, newdata = newobs3) %>% 
  as_tibble() %>% 
  mutate_all(as.numeric) %>% 
  rowwise() %>% 
  mutate(pov_diff = `2` - `1`)

exp_dist_diff <- pp %>% 
  ggplot(aes(x = pov_diff)) + 
  geom_histogram(aes(y = after_stat(count/sum(count))),
                 bins = 100) + 
  labs(title = "Posterior for Expected Distance Difference",
       subtitle = "The expected difference of average distance between polling locations with poverty rates of 0.5 and 0.8 is about 20 miles",
       x = "Poverty Rate",
       y = "Probability") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_classic()

exp_dist_diff
```

```{r}
newobs3 <- tibble(poverty = c(0.5, 0.8))

pp <- posterior_predict(fit_2, newdata = newobs3) %>% 
  as_tibble() %>% 
  mutate_all(as.numeric) %>% 
  rowwise() %>% 
  mutate(pov_diff = `2` - `1`)

exp_dist_diff_2 <- pp %>% 
  ggplot(aes(x = pov_diff)) + 
  geom_histogram(aes(y = after_stat(count/sum(count))),
                 bins = 100) + 
  labs(title = "Posterior for Expected Distance Difference",
       subtitle = "The expected difference of average distance between polling locations with poverty rates of 0.5 and 0.8 is about 5 miles",
       x = "Poverty Rate",
       y = "Probability") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_classic()

exp_dist_diff_2
```

## Representative Data


Let's look at how whether or not data is representative can affect our results. To do so, let's consider the following questions.

*Recall: the variable "distance" is the number of kilometers, which the person who is assigned to a given polling location, lives from that polling location. In Kenya today, what is the expected value of distance for polling locations with a poverty rate of 0.2?*

We will use the data set `kenya` to answer this question.

###

### Exercise 1

First, determine the columns we would like in our Preceptor Table in order to answer these questions.

```{r representative-data-ex-1}
question_text(NULL,
	message = "We would like the columns for poverty rate of voting blocks assigned to a polling location and the average distance people in a voting block have to travel to their polling location.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

###

Therefore, our Preceptor Table would appear as the following:

```{r}
tibble(ID = c("Community 1", "Community 2", "...", "Community 1000", "Community 1001", "..."),
       distance = c("23", "5", "...", "47", "32", "..."),
       poverty = c("0.4", "0.85", "...", "0.21", "0.63", "...")
       ) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
  cols_label(ID = md("ID"),
             distance = md("Distance"),
             poverty = md("Poverty Rate")) %>%
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = c(ID))) %>%
  tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
            locations = cells_column_labels(columns = c(ID))) %>%
  cols_align(align = "center", columns = everything()) %>%
  cols_align(align = "left", columns = c(ID)) %>%
  fmt_markdown(columns = everything())
```


### Exercise 2

Now, run `?kenya` to take a closer look at the data.

```{r representative-data-ex-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r representative-data-ex-2-hint, eval = FALSE}

```

###

Pay special attention to the variables we are looking at: distance and poverty. Notice that the definition of distance matches our definition from the questions we seek to answer. Additionally notice that the study worked with 1,674 voting blocks in Kenya.

### Exercise 3

Write two sentences discussing whether you can consider the data from `kenya` and the columns from our Preceptor Table to be drawn from the same population.

<!-- MM: What year is the data from? Should specify in below answer -->

```{r representative-data-ex-3}
question_text(NULL,
	message = "Since this data set dealt with a fairly large number of voting communities in Kenya at the time and our population is that of Kenya now. So, the difference between the data and our Preceptor Table is mostly time, which we will assume had little affect on poverty rates and voting blocks. So, we will assume that they can be drawn from the same population.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

###

Having determined that we can consider the data from `kenya` and our Preceptor Table to be drawn from the same population, our population table is the following:

```{r}
tibble(source = c("Preceptor Table", "Preceptor Table", "...", "Data", "Data", "...", "Other", "Other", "..."),
       year = c("2021", "2021", "...", "???", "???", "...", "?", "?", "..."),
       distance = c("32", "51", "...", "5", "41", "...", "?", "?", "..."),
       poverty = c("0.24", "0.55", "...", "0.81", "0.39", "...", "?", "?", "...")
       ) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
  cols_label(source = md("Source"),
             year = md("Year"),
             distance = md("Distance"),
             poverty = md("Poverty Rate")) %>%
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = c(source))) %>%
  tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
            locations = cells_column_labels(columns = c(source))) %>%
  cols_align(align = "center", columns = everything()) %>%
  cols_align(align = "left", columns = c(source)) %>%
  fmt_markdown(columns = everything())
```

### Exercise 4

Given our Population Table, let's consider the aspects of Justice. First, let's look at validity. Can we consider the columns `distance` and `poverty` to have the same meaning in our data and our Preceptor Table? Write two sentences considering this.

```{r wisdom-and-justice-4}
question_text(NULL,
	message = "We will consider our data to be valid, however, one point you may consider is if there was large redistricting that added more districts or changed the size of districts meaning that the average distance a voter would have to travel to reach their polling location per voting block would have vastly changed",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 5

Now, consider stability. Write two sentences considering whether we can consider the relationship between `distance` and `poverty` to be the same between "year of data" and 2021.

```{r wisdom-and-justice-5}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 6

Next, write two sentences determining if we can consider the data from "year" to be representative of the entirety of Kenya in "year". 

```{r wisdom-and-justice-6}
question_text(NULL,
	message = "Since, to our knowledge, areas of Kenya were not left out of the study and a large number of Kenya's voting block communities were studies, we can consider this data to be representative.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 7

Finally, as our last step of Justice, determine whether the data-generating mechanism is linear or logistic and why. Also state the corresponding family argument of `stan_glm()` needed to make that type of model. Use the phrase "outcome variable".

```{r wisdom-and-justice-7}
question_text(NULL,
	message = "The DGM will be linear because we can consider our outcome variable `distance` to be continuous and therefore we will set the family argument to 'gaussian'",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 4

Having completed Justice, we will now move onto Courage. Let's make our posterior distribution using 'stan_glm()'. Set your outcome variable as `distance`and your explanatory variable as `poverty` (Remember you must insert a tilde `~` between the two). Also, include a `-1` after `poverty` so we do not get an intercept.  Set `data` to `kenya`, and `refresh` to 0. Store this as `fit_1`.

```{r representative-data-ex-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r representative-data-ex-4-hint, eval = FALSE}
fit_1 <- stan_glm(distance ~ poverty -1,
                  data = ...,
                  refresh = ...)
```


```{r download-answers, child = "../../child_documents/download_answers.Rmd"}
```
