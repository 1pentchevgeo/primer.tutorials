---
title: Mapping
tutorial:
  id: mapping
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
description: Mapping data in R
---


```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(primer.data)
library(tidycensus)
library(ggthemes)
knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 
```

```{r copy-code-chunk, child = "../../child_documents/copy_button.Rmd"}
```

```{r info-section, child = "../../child_documents/info_section.Rmd"}
```

<!-- CHECKLIST BEFORE STARTING: -->
<!-- * Load necessary libraries for tutorial in the first code chunk -->
<!-- * Edit yaml at the START OF THIS FILE -->
<!-- * Review: https://ppbds.github.io/primer.tutorials/articles/instructions.html -->


<!-- ## First section (use sentence case) -->
<!-- ### -->

## Setup project
###

In this tutorial, we're going to be creating maps based off of US Census Bureau data. We'll be utilizing commands from the "Downloading Census Data" tutorial in order to do this, so please do that tutorial before starting on this one.

### Exercise 1

<!-- AG: I'm going to have them publish the maps because it's cool. These are the ramblings of a guy who's running on 4 hours of sleep though, so feel free to change it. -->

Let's start a new R project so that we can create and eventually publish our maps.

###

<!-- AG: Don't know what the syntax is for repo naming in the Primer, I think this is it. -->

Create a new GitHub repo titled `mapping-in-r` and link it to your RStudio like you have done so far. Remember to update the `.gitignore` file.

###

<!-- AG: Should we use terminal or console commands for this tutorial? I'm going with console for now since I'm way too used it after the RStudio and Friends tutorial. -->

Run `list.files()` in the Console to list all of the files. Copy and paste the output into the space below.

```{r setup-project-1}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 2))
```

###

We'll be working in this project for the rest of this tutorial.

### Exercise 2

Create a new R Markdown file titled `index.Rmd` and delete all of the things except for the setup chunk and the YAML header.

###

Run `list.files()` in the Console to list all of the files. Copy and paste the output into the space below.

```{r setup-project-2}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 2))
```

###

This should include the R Markdown file you created.

### Exercise 3

In this tutorial, we'll be using the **tidyverse**, **tidycensus**, and **ggthemes** packages. Load these packages in the setup chunk of your R Markdown file.

###

Run `readLines("index.Rmd") %>% tail(15)` in the Console to list all the lines in `index.Rmd`. Copy and paste the output into the space below.

```{r setup-project-4}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

You may have to install some of these packages as we progress.

## Mapping basics
###

You've likely heard of longitude and latitude, the global coordinate system that lets us pinpoint 2D locations on a 3D surface. This is also known as a **c**oordinate **r**eference **s**ystem, or **CRS**. CRSs use a 3D model of the Earth to define locations on the surface of a grid, with longitude determining the east/west distance and the latitude determining the north/south distance. 

###

CRS are used to define spatial data that we can then map. 

###

Spatial data with a defined CRS can either be vector or raster data. Vector data is based on points that can be connected to form lines and polygons. It is located within a coordinate reference system and is similar to what a roadmap would look like.

###

Raster data, however, are values within a grid system, such as satellite imagery. In this Primer, we will only be dealing with vector data, which is the format in which we get data from the **tidycensus** package.

###

In order to parse this information, we will be using the **sf** package to process vector data. The **sf** package stores data in data frames, allowing us to use the **dbplyr** methods that we're familiar with.

### Exercise 1

While R can handle a large amount of file formats for spatial data, we'll be focusing on shape files. While we refer to them as a "shapefile", it's actually composed of 3 basic files: `.shp` files for the shape and vertices, `.shx` files for indexes and offsets, and `.dbf` files to connect the geometry and the data. Luckily, this is already dealt with by **tidycensus** when it imports the Census shapefile.

###

In order to start mapping in R, we need to get a little more data from the **tidycensus** package. In particular, we need to set geometry = TRUE.

###

<!-- AG: Should we walk them through finding the variables again? -->

Add a new code chunk into your R Markdown file and add the `get_decennial()` function into it. Set the argument `geography` to `"state"`, `variables` to `"P001001"` and `"P002005"`, `year` to `2010`, `output` to `"wide"`, and `geometry` to `TRUE`.

Run `readLines("index.Rmd") %>% tail(15)` in the Console to list all the lines in `index.Rmd`. Copy and paste the output into the space below.

```{r mapping-basics-1}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 2))
```

###

<!-- AG: Can we link tutorials together like we do with Primer chapters? -->

We covered this command in the Downloading Census Data tutorial. Please complete that tutorial first before starting on this one in order to avoid any confusion.

### Exercise 2

<!-- AG: I'm just condensing the Primer info here and putting it in the tutorial. -->

If you run the code described in Exercise 1, you can see how there are a series of 5 columns: `GEOID`, `NAME`, `P001001`, `P002005`, and `geometry`.

This is different from the tibbles that we created before because there is now a strange "multipolygon" column called `geometry` and it's actually no longer a tibble. The "multipolygon" column contains the information needed to create maps and such, but this data prevents it from being a tibble.

In fact, if you run `class(rural)`, we can see that it's an `sf`, a special type of tibble that has plotting information. **Never use `as_tibble()` on an `sf` object unless you want to lose all of the plotting information.**

###

Let's create a map based on this `rural` data. This is similar to what we did before with `ggplot()`, but this time we use the function `geom_sf()`. Create a pipe using `rural` that contains `ggplot()` and `geom_sf()` like the previous plots.

###

Run `readLines("index.Rmd") %>% tail(15)` in the Console to list all the lines in `index.Rmd`. Copy and paste the output into the space below.

```{r mapping-basics-2}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

You may notice that the plot is very stretched out with Hawaii suddenly being on the other side of the map. Let's try to fix that.

### Exercise 3

<!-- Prettying it up -->

```{r mapping-basics-3}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 4

<!-- scale_fill_viridis -->

```{r mapping-basics-4}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 5

<!-- labs -->

```{r mapping-basics-5}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 6

<!-- adding Alaska and Hawaii -->

```{r mapping-basics-6}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

## Faceting maps

<!-- description -->

### Exercise 1

<!-- building racevars by looking at load_variables -->

```{r faceting-maps-1}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 2

<!-- get_acs command, have them sub in their county and state -->

```{r faceting-maps-2}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 3

<!-- mutate to have percent -->

```{r faceting-maps-3}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 4

<!-- ggplot and aes and geom_sf() -->

```{r faceting-maps-4}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 5

<!-- facet wrap -->

```{r faceting-maps-5}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 6

<!-- scale_fill_viridis_c -->

```{r faceting-maps-6}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 7

<!-- scale_color_viridis_c -->

```{r faceting-maps-7}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 8

<!-- labs -->

```{r faceting-maps-8}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 9

<!-- theme void -->

```{r faceting-maps-9}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

## Dealing with big data

<!-- description -->

### Exercise 1

<!-- find variables -->

```{r dealing-with-big-dat-1}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 2

<!-- create continental that excludes Alaska and Hawaii -->

```{r dealing-with-big-dat-2}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 3

<!-- get_acs command -->

```{r dealing-with-big-dat-3}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 4

<!-- generate percent column -->

```{r dealing-with-big-dat-4}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 5

<!-- ggplot and geom_sf -->

```{r dealing-with-big-dat-5}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 6

<!-- scale_fill_viridis_c -->

```{r dealing-with-big-dat-6}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 7

<!-- labs -->

```{r dealing-with-big-dat-7}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 8

<!-- theme_void() -->

```{r dealing-with-big-dat-8}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

## PUMS data

<!-- description -->

### Exercise 1

<!-- pums_variables -->

```{r pums-data-1}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 2

<!-- get_pums -->

```{r pums-data-2}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 3

<!-- nw_states creation -->

```{r pums-data-3}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 4

<!-- map() -->

```{r pums-data-4}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 5

<!-- get_pums() -->

```{r pums-data-5}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 6

<!-- group_by() -->

```{r pums-data-6}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 7

<!-- summarize pt 1 -->

```{r pums-data-7}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 8

<!-- summarize pt 2 -->

```{r pums-data-8}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 9

<!-- left_join for some reason -->

```{r pums-data-9}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 10

<!-- ggplot and geom_sf() -->

```{r pums-data-10}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 11

<!-- scale_fill_viridis_b and args -->

```{r pums-data-11}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 12

<!-- labs -->

```{r pums-data-12}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

### Exercise 13

<!-- theme_void -->

```{r pums-data-13}
question_text(NULL,
	message = "answer here",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###

Congratulations on completing the tutorial.

If you want to explore further:

- Take a look at the [**tidycensus** website](https://walkerke.github.io/tidycensus/).
- If you have shapefiles from a place other than **tidycensus**, you can read them in using `st_read()` in the **sf** package, join them with other data using **dplyr** functions, and then map them with `geom_sf()` as we have shown above.
    - You may have to look into using [`coord_sf()`](https://ggplot2.tidyverse.org/reference/ggsf.html) if you have trouble displaying your data.
- Want to add interactivity to your maps?  Check out the **leaflet** package.  [Here's](https://juliasilge.com/blog/using-tidycensus/) a good introduction to using **leaflet** with **tidycensus**.
- Practice your skills with [Andrew Tran's case study slides](https://andrewbtran.github.io/NICAR/2019/mapping/02_case_study_slides.html), where you can replicate a graphic from the Washington Post. Note: this involves some packages we haven't shown you in this book, but if you follow along step by step you will be able to see how they are used.

Downloading feature geometry from the Census website.  To cache shapefiles for use in future sessions, set `options(tigris_use_cache = TRUE)`.

###

```{r download-answers, child = "../../child_documents/download_answers.Rmd"}
```
