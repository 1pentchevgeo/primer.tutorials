---
title: "API"
tutorial:
  id: "data-api"
output:
  learnr::tutorial:
      progressive: true
      allow_skip: true
runtime: shiny_prerendered
description: "Chapter 3: Working with APIs"
---

```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(httr)
knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 

# Objects created here are available in every code chunk.

meso_url <- "https://mesonet.agron.iastate.edu/cgi-bin/request/asos.py/"

```


<!-- > denver <- GET(url = meso_url) -->
<!-- > denver -->
<!-- Response [https://mesonet.agron.iastate.edu/cgi-bin/request/asos.py/] -->
<!--   Date: 2021-05-22 14:28 -->
<!--   Status: 500 -->
<!--   Content-Type: text/plain; charset=UTF-8 -->
<!--   Size: 23 B -->

<!-- > class(denver) -->
<!-- [1] "response" -->
<!-- >  -->

## Information
###

```{r information}
quiz(caption = "",
  question_text(
    "Name:",
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL),
  question_text(
    "Email:",
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL))
```

## Queries
###

In order to get data from an API, we use the **httr** package.


<!-- DK: First question, library(httr). -->

### Exercise 1


Because the Iowa Environmental Mesonet doesn't require us to use a user-specific API key, we can use a base URL to send an HTTP request. 

Create an object named `meso_url` that contains the URL listed in **Primer** chapter `3.6`. 

###

```{r create_url, exercise = TRUE}

```

```{r create_url-hint, eval = FALSE}
The URL should be a text string when being assigned to an object. 
```

###

Tell me something useful.

### Exercise 2

Now we want to know more about average temperatures across the U.S. in 2019. Use the object created above to fill in the `url` argument and the appropriate city abbreviation for Denver within the `GET()` function to create an object named `denver`. Note that we want to know the temperature in Farenheight degrees, and that you should also tell the query what year you are interested in. 

```{r query-1, exercise = TRUE}



```

```{r query-1-hint-1, eval = FALSE}
The abbreviation for temperature in F* is "tmpf".
```

```{r query-1-hint-2, eval = FALSE}
... <- GET(url = ...,
                    query = list(station = ...,
                                 data = "tmpf",
                                 year1 = ...))
```

### Exercise 3

Notice that we can't quite use the output given from that query - though it does return something. Now you should extend the query to include the start and end point of your time frame - the first and last days of the year.

```{r query-2, exercise = TRUE}

```

```{r query-2-hint, eval = FALSE}
The start and end args. follow the naming system year1, year2, month1, month2 etc. 
```

### Exercise 4

While that was more specific, we still get unusable data. This time, add the time zone 'tz' argument to the query as well as setting the format argument equal to 'comma' (as in Comma Separated Variables). 

```{r query-3, exercise = TRUE}

```

```{r query-3-hint, eval = FALSE}
The time zone for Denver is "America/Denver". 
```


### Exercise 5

Finally, to convert this data to a more familiar format, add the `content()` and `read_csv()` functions immediately following the `GET()` query to convert the jibberish from the query response into a nicely formatted tibble. Save this output as an object named 'denver'. 

```{r query-4, exercise = TRUE}


```

```{r query-4-hint, eval = FALSE}
... <- GET(...) %>% 
  content() %>% ...


Make sure that you address the NA values properly. See the Primer for examples. 
```


## Weather

Now that we have our data, we can proceed to work with it. We will now create the following plot of daily average temperatures in Boston MA, Denver CO, Miami FL, Anchorage AK, and San Francisco CA. 

```{r plot_example}


denver <- GET(url = meso_url,
                    query = list(station = c("DEN"),
                                 data = "tmpf",
                                 year1 = "2019",
                                 month1 = "1",
                                 day1 = "1",
                                 year2 = "2019",
                                 month2 = "12",
                                 day2 = "31",
                                 tz = "America/Denver",
                                 format = "comma")) %>%
  content() %>% 
  read_csv(skip = 5, na = "M")



# merged1 <- merged %>% 
#   separate(col = valid,
#            into = c("date", NA),
#            sep = " ") %>% 
#   group_by(station, date) %>% 
#    summarise(avg_temp = mean(tmpf, na.rm = TRUE),
#              .groups = "drop")
# 
# temp_p <- merged1 %>% 
#   ggplot(aes(x = station, y = avg_temp, color = station)) +
#   geom_jitter() +
#   labs(title = "Average Temperature Across the U.S. (2019)",
#        subtitle = "Temperatures recorded daily",
#        y = "Avg. Temp. Farenheight",
#        x = "City", 
#        caption = "Source: Iowa Environmental Mesonet") +
#   theme(legend.position = "none") +
#   scale_x_discrete(labels = c("Boston", "Denver", "Miami", 
#                               "Anchorage", "San Fran."))
# 
# temp_p
# 
# 

# cleanup workflow

# d <- denver %>% 
#   separate(col = valid,
#            into = c("date", NA),
#            sep = " ") %>%
#   group_by(date) %>%
#   summarise(avg_temp = mean(tmpf, na.rm = TRUE))
```


## Submit

```{r context = "setup"}
submission_ui
```

```{r context = "server"}
submission_server()
```
