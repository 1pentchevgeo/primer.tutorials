---
title: "Rubin Causal Model"
tutorial:
  id: "rubin-causal-model"
output:
  learnr::tutorial:
      progressive: true
      allow_skip: true
runtime: shiny_prerendered
description: "Chapter 4 Tutorial"
---

```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(gt)
knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 
```


<!-- After the definitions, we could have some problems which use the actual train data, calculate some causal effects and then plot them. Lots of good staff there. First, assume a single tau. What is it? How sure are you? Then separate taus for men and women. Or some other grouping. Show facetted plot. -->

<!-- One question could take the trains data and make a Preceptor table. Learn a little gt! Would also need some manipulation. -->

<!-- More about confounding. -->



<!-- * Could you walk someone through a by-hand permutation test? That would be cool! But then we would need to cover it in the chapter. And that is too much. Maybe a problem set? -->



## Introduction
###

The Rubin Causal Model is the most popular and powerful framework for studying cause and effect in the social sciences. 


## Information
###

```{r information}
quiz(caption = "",
  question_text(
    "Name:",
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL),
  question_text(
    "Email:",
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL))
```


## Definitions
###

If you have read the chapter, then these questions should be easy.


### Exercise 1

In your own words, give a one sentence definition of a Preceptor Table.

```{r def-ex-1}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 3))
```

### Exercise 2

In your own words, give a one sentence definition of a potential outcome.

```{r def-ex-2}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 3))
```


### Exercise 3

In your own words, give a one sentence definition of a causal effect.

```{r def-ex-3}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 3))
```

### Exercise 4

Give a paragraph explanation about the Fundamental Problem of Causal Inference. Include an example relating to your own life.

```{r def-ex-4}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 7))
```

### Exercise 5

In two sentences, explain what what an *ideal* Preceptor Table is, and why is this generally impossible to observe. Use the phrase 'potential outcomes' in your answer.

```{r def-ex-5}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 5))
```


### Exercise 6

In one sentence, explain the difference between an *actual* Preceptor Table and an *ideal* Preceptor Table.

```{r def-ex-6}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 3))
```


## Causal effects
###



Use the following ideal Preceptor Table to answer some questions about potential estimands we might be interested in.

```{r question-estimands2-setup, echo = FALSE}

tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       ytreat = c("11", "13", "10", "8", "6"),
       ycontrol = c("9", "10", "11", "10", "4"),
       ydiff = c("?", "?", "?", "?", "?")) %>%
  gt() %>%
  cols_label(subject = md("$$ID$$"),
                ytreat = md("$$Y_t(u)$$"),
                ycontrol = md("$$Y_c(u)$$"),
                ydiff = md("$$Y_t(u) - Y_c(u)$$"))  %>%
  cols_move(columns = vars(ytreat, ycontrol), after = vars(subject)) %>%
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = vars(subject))) %>%
  cols_align(align = "center", columns = TRUE) %>%
  cols_align(align = "left", columns = vars(subject)) %>%
  fmt_markdown(columns = TRUE)  %>%
  tab_spanner(label = "$$Outcome$$", vars(ytreat, ycontrol))  %>%
  tab_spanner(label = "$$Causal Effect$$", vars(ydiff))
```

### Exercises 1 to 3

```{r ce-ex-1}
quiz(

  question("What is the causal effect of the treatment on Yao?",
    answer("1"),
    answer("2", correct = TRUE),
    answer("3"),
    answer("4"),
    answer("5"),
    allow_retry = FALSE),

  question("For how many of the five people is the causal effect of the treatment positive?",
    answer("1"),
    answer("2"),
    answer("3", correct = TRUE),
    answer("4"),
    answer("5"),
    allow_retry = FALSE),

  question("On whom did the treatment have the most negative causal effect?",
    answer("Yao"),
    answer("Emma"),
    answer("Cassidy"),
    answer("Tahmid", correct = TRUE),
    answer("Diego"),
    allow_retry = FALSE)
)
```



## One tau
###

In these exercises, we will assume that the causal effect, $\tau$ (pronounced tau), is the same for everyone.


<!-- DK: Why make the math hard? This should be easy to do in your head.  -->

Use the following actual Preceptor Table to answer questions about a single value for tau.

```{r question-singletau-setup, echo = FALSE}
# First, we create a tibble with the values we want for the table

tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       ytreat = c("13", "11", "?", "?", "5"),
       ycontrol = c("?", "?", "10", "12", "?"),
       ydiff = c("?", "?", "?", "?", "?")) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
  cols_label(subject = md("$$ID$$"),
                ytreat = md("$$Y_t(u)$$"),
                ycontrol = md("$$Y_c(u)$$"),
                ydiff = md("$$Y_t(u) - Y_c(u)$$")) %>%
  cols_move(columns = vars(ytreat, ycontrol), after = vars(subject)) %>%
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = vars(subject))) %>%
  cols_align(align = "center", columns = TRUE) %>%
  cols_align(align = "left", columns = vars(subject)) %>%
  tab_spanner(label = "$$Outcomes$$", vars(ytreat, ycontrol)) %>%
  tab_spanner(label = "$$Estimands$$", vars(ydiff)) %>%
  fmt_markdown(columns = TRUE)
```

### Exercise 1

Describe in one sentence/equation how you would estimate Yao's $Y_c(u)$. (Do not use actual numbers, use "tau" in your explanation).

```{r 1-tau-ex-1}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 2))
```

### Exercise 2

Describe in one sentence/equation how you would estimate Tahmids's $Y_t(u)$. (Do not use actual numbers, use tau in your explanation).

```{r 1-tau-ex-2}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 2))
```

### Exercise 3

Describe in one sentence/equation how you would estimate a single value for tau.

```{r 1-tau-ex-3}
question_text(NULL,
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL,
    options = list(nrows = 2))
```

### Exercises 4 to 6

```{r 1-tau-ex-4}
quiz(

  question("What is your estimate for a single value for tau?",
    answer("-2.33"),
    answer("-1.33", correct = TRUE),
    answer("-1"),
    answer("0"),
    answer("1.33"),
    allow_retry = FALSE),

  question("What is your estimate for $Y_c(u)$ for Emma?",
    answer("10.33"),
    answer("11.33"),
    answer("12.33", correct = TRUE),
    answer("12.67"),
    answer("13"),
    allow_retry = FALSE),

  question("What is your estimate for $Y_t(u)$ for Cassidy?",
    answer("6.67"),
    answer("7.33"),
    answer("7.67"),
    answer("8.67", correct = TRUE),
    answer("9"),
    allow_retry = FALSE)
)
```



## Two taus
###

As we do in the book, let's now assume that the causal effect varies by sex. We will estimate two values for tau. (Cassidy and Emma are female, Tahmid, Diego, and Yao are male).

### Exercise 1

```{r question-twotau-setup, echo = FALSE}
# First, we create a tibble with the values we want for the table

tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       ytreat = c("13", "11", "?", "?", "5"),
       ycontrol = c("?", "?", "10", "12", "?"),
       ydiff = c("?", "?", "?", "?", "?")) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
  cols_label(subject = md("$$ID$$"),
                ytreat = md("$$Y_t(u)$$"),
                ycontrol = md("$$Y_c(u)$$"),
                ydiff = md("$$Y_t(u) - Y_c(u)$$")) %>%
  cols_move(columns = vars(ytreat, ycontrol), after = vars(subject)) %>%
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = vars(subject))) %>%
  cols_align(align = "center", columns = TRUE) %>%
  cols_align(align = "left", columns = vars(subject)) %>%
  tab_spanner(label = "$$Outcomes$$", vars(ytreat, ycontrol)) %>%
  tab_spanner(label = "$$Estimands$$", vars(ydiff)) %>%
  fmt_markdown(columns = TRUE)
```


```{r question-two-tau}
quiz(
  question_text("How would you calculate $\\tau_F$? Use only words and no numbers.",
    allow_retry = FALSE,
    answer(NULL, correct = TRUE),
    trim = FALSE,
    incorrect = "Ok"
  ),
  question_text("What is $\\tau_M$? (Answer as +/-X)",
    answer("-3", correct = TRUE),
    allow_retry = TRUE
  ),
  question_text("What is your new estimate for Diego's $Y_c(u)$? (Answer as X)",
    answer("8", correct = TRUE),
    allow_retry = TRUE
  ),
  question_text("In a couple of sentences, explain how we have two different estimates for Emma depending on assumptions we make.",
    allow_retry = FALSE,
    answer(NULL, correct = TRUE),
    trim = FALSE,
    incorrect = "Ok"
  )
)
```


## Average treatment effect
###

We will no longer make any assumptions about $\tau$. Instead, we are interested in estimating the average treatment effect, both for the entire sample and for subsets of it.


### Exercise 1

```{r question-setup, echo = FALSE}

tibble(subject = c("Yao", "Emma", "Cassidy", "Tahmid", "Diego"),
       ytreat = c("11", "13", "?", "?", "6"),
       ycontrol = c("?", "?", "11", "10", "?"),
       ydiff = c("?", "?", "?", "?", "?")) %>%
  gt() %>%
  cols_label(subject = md("$$\\mathbf{Subject}$$"),
                ytreat = md("$$Y_t(u)$$"),
                ycontrol = md("$$Y_c(u)$$"),
                ydiff = md("$$Y_t(u) - Y_c(u)$$")) %>%
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = vars(subject))) %>%
  tab_style(cell_text(weight = "bold"),
            location = cells_body(columns = vars(subject))) %>%
  cols_align(align = "center", columns = TRUE) %>%
  fmt_markdown(columns = TRUE)

```

```{r question-2-2}
quiz(
question("Estimate the ATE based on the data given to you in the above Preceptor Table.",
    answer("-0.5", correct = TRUE),
    answer("+1"),
    answer("-1.33"),
    answer("+2"),
    allow_retry = TRUE)
)
```

<div id="question-2-2-hint">
**Hint:**  Average of treated values minus the average of control values is the standard way of estimating the ATE.
</div>

<!-- DK: Shouldn't all of these be split into separate Exercises? That would mean putting each of them in their own R code chunk, which seems preferable. -->

<!-- DK: Make the math easy to do in your head! Integers only. -->

<!-- DK: Is there a way to ensure that the answers are correct by, for example, calculating them directly from the data which makes the table? -->

<!-- DK: Cut half of these as being too repetitive. -->

### Exercise 2

```{r question-2-3-a--quiz}
quiz(
question_text("Before assigning any number to our causal effect, let's work using a single causal effect for everyone called $\\tau$. What would be Yao's $Y_c(u)$. You can write tau for $\\tau$. Don't put spaces in your answer. Your answer should look like 13+tau or 10-tau.",
    allow_retry = TRUE,
    answer("11-tau", correct = TRUE)
  ),

question_text("Using the same format, write Cassidy's $Y_t(u)$ in terms of $\\tau$ and the known value for Cassidy's $Y_c(u)$.",
    allow_retry = TRUE,
    answer("11+tau", correct = TRUE)
  ),

question_text("What is Cassidy's outcome under treatment if we assume tau to be the ATE we calculated above, which was -0.5? Note that this answer will just be a number, without any symbol.",
    allow_retry = TRUE,
    answer("10.5", correct = TRUE)
  ),

question_text("What is Tahmid's outcome under treatment if we assume tau to be the ATE we calculated?",
    allow_retry = TRUE,
    answer("9.5", correct = TRUE)
  ),

question_text(
    "What is the treatment effect for the males in the sample?",
    allow_retry = TRUE,
    answer("-1.5", correct = TRUE)
  ),

question_text(
    "What is the treatment effect for the females in the sample?",
    allow_retry = TRUE,
    answer("2", correct = TRUE)
  ),

question_text(
    "What is Diego's $Y_c(u)$ if we assume his causal effect to be the estimated ATE for males",
    allow_retry = TRUE,
    answer("7.5", correct = TRUE)
  ),

question_text(
    "What is Emma's $Y_c(u)$ if we assume her causal effect is the estimated ATE for females",
    allow_retry = TRUE,
    answer("11", correct = TRUE)
  )
)

```

### Exercise 3

```{r question-2-4-quiz}

quiz(

question("Which of the following is NOT a reason why $\\widehat{ATE}$ a useful estimand?",
    answer("It captures a clear and useful estimator"),
    answer("If the treatment is randomly assigned, the estimator is unbiased"),
    answer("You can use to fill out Preceptor Table if you assume the treatment effect is the same for everyone"),
    answer("$\\widehat{ATE}$ always captures the correct sign (+ or -) of the true ATE", correct = TRUE, message = "Nice! This is untrue. Our estimates for ATE can often get even the direction of the ATE wrong."),
    allow_retry = TRUE
  ),

question_text("What is the difference between $\\widehat{ATE}$ and ATE.", 
    allow_retry = TRUE,
    answer(NULL, correct = TRUE),
    incorrect = "Ok"
  ),

question_text("Describe the heterogeneous treatment effect for the variation between individuals.",
    allow_retry = TRUE,
    answer(NULL, correct = TRUE),
    incorrect = "Ok"
  ),

question_text("Describe heterogeneous treatment effect for the variation between different sub-groups or variables.",
    allow_retry = TRUE,
    answer(NULL, correct = TRUE),
    incorrect = "Ok"
  )
)

```




## Submit

```{r context="setup"}
submission_ui
```

```{r context="server"}
submission_server()
```
