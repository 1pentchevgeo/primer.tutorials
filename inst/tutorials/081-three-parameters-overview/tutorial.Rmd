---
title: 'Three Parameters: Overview'
tutorial:
  id: three-parameters-overview
output:
  learnr::tutorial:
    progressive: yes
    allow_skip: yes
runtime: shiny_prerendered
description: 'Questions for Chapter 8: Three Parameters.'
---

```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(primer.data)
library(rstanarm)
library(gt)
knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 

```

```{r copy-code-chunk, child = "../../child_documents/copy_button.Rmd"}
```

```{r info-section, child = "../../child_documents/info_section.Rmd"}
```

<!-- Make the tutorial follow the chapter very closely: section by section. -->

<!-- Use our new skeletons.  -->

<!-- Change text questions to allow for written answers, and then provide your own perfect written answders. -->

## Wisdom

Our first step when considering our Cardinal Virtues is Wisdom. This pertains to considering the questions we strive to answer and the population for which we would like to answer them for, while also recognizing the data we would ideally have as compared to what we do.

<!-- MM: Make population below more clear -->

###

### Exercise 1

In order to answer the following questions, what columns would we like to have in our Preceptor Table.

*What is the probability that if a Democrat shows up to a train station in the U.S today, he will be over 50 years old?*

*In a group of train commuters in the U.S. today in which three are Democrats and three are Republicans, what will the age difference be between the oldest Democrat and the youngest Republican?* 


```{r Wisdom-1}
question_text(NULL,
	message = "We would have columns for party and age of train commuters.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 2

Next consider the following questions and the columns needed in the Preceptor Table to answer them.

*What is the average treatment effect, of exposing U.S train commuters today to Spanish-speakers, on their attitudes toward immigration?* 

*What is the largest causal effect on immigration attitudes due to exposing U.S. train commuters today to Spanish-speakers which still has a 1 in 10 chance of occurring?*

```{r Wisdom-2}
question_text(NULL,
	message = "These questions would require a column for the immigration attitudes for someone who was not exposed to spanish-speakers and for someone who wasn't.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 3

Continue this process for the following question.

*What would you expect the income to be for a random 40 year old train commuter in the U.S. today?*

```{r Wisdom-3}
question_text(NULL,
	message = "The columns we would need would be age and income.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 4

And for the following two questions as well.

*Among all people who have an income $100,000, what proportion are liberal?*

*Assume we have a group of eight people, two of whom make $100,000, two $200,000, two $300,000 and two $400,000. How many will be liberal?*


```{r Wisdom-ex-4}
question_text(NULL,
	message = "We would need a column for income, and a column for whether someone is liberal or not.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### 

In the past four exercises, we have executed the first step of Wisdom, in considering the questions and figuring out ideally what data we would have to answer them. In doing so, we have determined the columns of our Preceptor Table, those being age, political party, immigration attitude for those who were exposed to Spanish speakers and for those who weren't, as well as income, and being liberal or not. 

The combined Preceptor Table for all the question is shown below.

```{r echo = FALSE}
tibble(ID = c("Commuter 1", "Commuter 2", "...", "Commuter 1000", "Commuter 1001", "..."),
       age = c("23", "18", "...", "49", "38", "..."),
       party = c("Democrat", "Republican", "...", "Republican", "Democrat", "..."),
       income = c("50000", "150000", "...", "100000", "200000", "..."),
       liberal = c("Liberal", "Not Liberal", "...", "Liberal", "Liberal", "..."),
       attitude_after_control = c("3", "7", "...", "4", "9", "..."),
       attitude_after_treated = c("8", "7", "...", "8", "7", "...")
       ) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
  cols_label(ID = md("ID"),
             age = md("Age"),
             party = md("Party"),
             income = md("Income"),
             liberal = md("Liberal"),
             attitude_after_control = md("Control Ending Attitude"),
             attitude_after_treated = md("Treated Ending Attitude")) %>%
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = c(ID))) %>%
  tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
            locations = cells_column_labels(columns = c(ID))) %>%
  cols_align(align = "center", columns = everything()) %>%
  cols_align(align = "left", columns = c(ID)) %>%
  fmt_markdown(columns = everything())
```

<!-- DK: Show the table! -->

### Exercise 5

Next, let's take a look at the dataset we would like to use to answer these questions. We will be using `trains`. First, let's take a look at trains through the glimpse method.

```{r Wisdom-4, exercise = TRUE}

```

```{r Wisdom-4-hint-1, eval = FALSE}
glimpse(trains)
```

### 

Notice that `att_end` is an integer rather than a double and that `party` is a character while `treatment` is a factor. 

### Exercise 6

Next, learn more about the data set by calling '?trains'. 

```{r Wisdom-5, exercise = TRUE}

```

```{r Wisdom-5-hint-1, eval = FALSE}
?trains
```

Notice how `att_end` represents immigration attitudes after treatment of being exposed to Spanish-speakers on a scale of 3 to 15, where higher numbers indicate a more conservative attitude.

### Exercise 7

Now, with a greater understanding of the data, determine how well the data we have matches up with the data we indicated we would need in our Preceptor Table to answer all the questions.

```{r Wisdom-6}
question_text(NULL,
	message = "We can answer every question since we have the data to do so. We will need the columns of age, income, party, liberal, att_end and treatment. This is because we need to know the age, income, political party, and whether or not someone is liberal. Additionally, att_end is the individual's ending attitude on immigration and treatment is whether or not the individual was exposed to Spanish-speakers.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 8

Recall that this study was done in Boston, MA in 2012. Discuss whether you believe it's reasonable to consider this data to be drawn from the same population as our Preceptor Table. 

```{r Wisdom-7}
question_text(
  '',
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Text for button",
	incorrect = NULL)
```

### 

While you may or may not believe that the data can be applied to our population, it is necessary to discuss how the populations may be similar and different in order to determine whether we can continue. 

For our purposes, we will assume that the data is drawn from the same population and can be applied to our population. 

### 

We have now completed Wisdom by creating our Preceptor Table and analyzing our data and determining its application to our questions and our population. Therefore, let's take a look at our population table.

```{r}
tibble(source = c("Preceptor Table", "Preceptor Table", "Preceptor Table",  "...", "Data", "Data", "Data", "...", "Population", "Population", "Population"),
       city = c("Chicago, IL", "Seattle, WA", "Atlanta, GA", "...",
                  "Boston, MA", "Boston, MA", "Boston, MA", "...",
                  "?", "?", "?"),
       year = c("2021", "2021", "2021", "...",
                "2012", "2012", "2012", "...",
                "?", "?", "?"),
       age = c("?", "?", "?", "...",
                 "43", "52", "28", "...",
                 "?", "?", "?"),
       party = c("?", "?", "?", "...", 
                  "Democrat", "Republican", "Republican", "...",
                  "?", "?", "?"),
       income = c("?", "?", "?", "...", 
                    "150000", "50000", "200000", "...",
                    "?", "?", "?"),
       liberal = c("?", "?", "?", "...", 
                 "Liberal", "Liberal", "Not Liberal", "...",
                 "?", "?", "?"),
       att_treat = c("?", "?", "?", "...", 
                 "6", "8", "4", "...",
                 "?", "?", "?"),
       att_control = c("?", "?", "?", "...", 
                 "4", "2", "5", "...",
                 "?", "?", "?")) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
  cols_label(source = md("Source"),
             city = md("City"),
             year = md("Year"),
             age = md("Age"),
             party = md("Party"),
             income = md("Income"),
             liberal = md("Liberal"),
             att_treat = md("Treatment"),
             att_control = md("Control")) %>%
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = c(source))) %>%
  tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
            locations = cells_column_labels(columns = c(source))) %>%
  cols_align(align = "center", columns = everything()) %>%
  cols_align(align = "left", columns = c(source)) %>%
  fmt_markdown(columns = everything())  
```

Remember that since we are considering the data from 2012 and from now to be drawn from the same population, then  we are assuming that between 2012 and now, not much has changed in terms of the age distribution or party affiliation, etc., of train commuters. Therefore, we also assume that this data could be applied to some range of years before and after 2012 which includes 2021. Additionally, if we are assuming that the data specific to train stations in Boston, MA, is drawn from the same population as our population of train commuters in the U.S. today, then that also indicates to us that the population table will include commuters from locations in cities around the U.S..

## age ~ party

```{r}
fit_1 <- stan_glm(age ~ party - 1, 
                    data = trains, 
                    seed = 17,
                    refresh = 0)

new_obs <- tibble(party = "Democrat")

pp <- posterior_predict(fit_1, newdata = new_obs) %>% 
  as_tibble() %>% 
  mutate_all(as.numeric)
```

Now that we have completed Wisdom for all of our questions, let's look at the ones dealing specifically with the relation between age and party.

*What is the probability that if a Democrat shows up to the train station, he will be over 50 years old?*

*In a group of three Democrats and three Republicans, what will the age difference be between the oldest Democrat and the youngest Republican?* 

### Exercise 1

To do so, let's first narrow down the population table from the ending of our Wisdom section to the columns pertaining to these questions. Determine the outcome variable and explanatory variable for this model.

```{r age--party-ex-1}
question_text(NULL,
	message = "The outcome variable is age while the explanatory age is party.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

###
 
This allows us to make the population table for this model, as seen below.

```{r}
tibble(source = c("Preceptor Table", "Preceptor Table", "Preceptor Table",  "...", "Data", "Data", "Data", "...", "Population", "Population", "Population"),
       city = c("Chicago, IL", "Seattle, WA", "Atlanta, GA", "...",
                  "Boston, MA", "Boston, MA", "Boston, MA", "...",
                  "?", "?", "?"),
       year = c("2021", "2021", "2021", "...",
                "2012", "2012", "2012", "...",
                "?", "?", "?"),
       age = c("?", "?", "?", "...",
                 "43", "52", "28", "...",
                 "?", "?", "?"),
       party = c("?", "?", "?", "...", 
                  "Democrat", "Republican", "Republican", "...",
                  "?", "?", "?")) %>%
  
  # Then, we use the gt function to make it pretty
  
  gt() %>%
  cols_label(source = md("Source"),
             city = md("City"),
             year = md("Year"),
             age = md("Age"),
             party = md("Party"),
             income = md("Income"),
             liberal = md("Liberal"),
             att_treat = md("Treatment"),
             att_control = md("Control")) %>%
  tab_style(cell_borders(sides = "right"),
            location = cells_body(columns = c(source))) %>%
  tab_style(style = cell_text(align = "left", v_align = "middle", size = "large"), 
            locations = cells_column_labels(columns = c(source))) %>%
  cols_align(align = "center", columns = everything()) %>%
  cols_align(align = "left", columns = c(source)) %>%
  fmt_markdown(columns = everything())  
```


### Exercise 1

Let's consider how this data was collected. Essentially, in 9 train stations in Boston, MA., train commuters on two trains were given surveys before and after their respective treatments, one train receiving the control, and the other being exposed to Spanish-speakers. However, participation and submission of this form was voluntary and induced by payment.

With this knowledge, we must consider the representativeness of the data. Write t sentences discussing an assumption that we must make given the voluntary participation used to collect the data.

```{r age--party-1}
question_text(NULL,
	message = "Since the participation was voluntary, we must assume that those who decide to fill out the survey will not be very different from those who don't decide to fill out the survey.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 2

After thoroughly considering how the data is representative of our population, we must then consider the validity for age and party affiliation. 

Write 2 sentences discussing the validity of `party`. Has the meaning of being a Democrat or a Republican changed between 2012 and now? 

```{r age--party-2}
question_text(
	"prompt here",
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Text for button",
	incorrect = NULL)
```

Through the past two steps, we have completed the steps of Justice.

### Exercise 3

Now, let's make our posterior distribution using 'stan_glm()'. Set your outcome variable as `age`and your explanatory variable as `party` (Remember you must insert a tilde `~` between the two). Also, include a `-1` after `liberal` so we do not get an intercept.  Set `data` to `trains`, and `refresh` to 0 

```{r age--party-3, exercise = TRUE}

```

```{r age--party-3-hint-1, eval = FALSE}
stan_glm(age ~ party - 1, 
                    data = ...,
                    refresh = ..)
```

### Exercise 4

Store the above in an object called `fit_1` and print it out. 

```{r age--party-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-4-hint-1, eval = FALSE}
fit_1 <- ...
```

### Exercise 5

Now let's display this information graphically. To do so, we will make the below plot.

```{r}
age_party_graph <- fit_1 %>%
  as_tibble() %>%
  select(-sigma) %>%
  mutate(Democrat = partyDemocrat, Republican = partyRepublican) %>%
  pivot_longer(cols = Democrat:Republican,
               names_to = "parameter",
               values_to = "age") %>%
  ggplot(aes(x = age, fill = parameter)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5,
                   bins = 100,
                   position = "identity") +
    labs(title = "Posterior for Average Age",
         subtitle = "More data allows for a more precise posterior for Democrats",
         x = "Age",
         y = "Probability") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_classic()

age_party_graph
```

First, let's make `fit_1` into a tibble and remove `sigma` since it is not of relevance to us. Remember that we need to use `as_tibble()`.

```{r age--party-5, exercise = TRUE}

```

```{r age--party-5-hint-1, eval = FALSE}
fit_1 %>% 
  as_tibble() %>% 
  select(- sigma)
```

### Exercise 6

Continue the pipe and change the labels of 'partyDemocrat' and 'partyRepublican' to be 'Democrat' and 'Republican' respectively. Print the tibble.

```{r age--party-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-6-hint-1, eval = FALSE}
... %>% 
  mutate(Democrat = partyDemocrat, Republican, partyRepublican)
```

### Exercise 7

Continue this pipe and use `pivot_longer()` with the arguments `names_to` set to "parameter" and `values_to` set to "age".

```{r age--party-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-7-hint-1, eval = FALSE}
... %>% 
pivot_longer(cols = ...,
             names_to = ...
             values_to = ...)
```

### Exercise 8

Next, let's plot this. Map `age` to the x-axis and set `parameter` to fill. Then use `geom_histogram()`.

```{r age--party-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-8-hint-1, eval = FALSE}
... %>% 
  ggplot(aes(x = ..., fill = ...)) %>% 
  geom_histogram()
```

### Exercise 9

Now convert the y-axis to be a probability by using `aes()` in the first parameter of `geom_histogram()`. Additionally, set `alpha` to 0.5, `bins` to 100, and `position` to "identity".

```{r age--party-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-9-hint-1, eval = FALSE}
... geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5,
                   bins = 100,
                   position = "identity")
```

### Exercise 10

Now, add labels and change the scale on the y-value to make it into a percent format. Also add `theme_classic()`. 

The graph should look something like the following:

```{r age--party-10, echo = FALSE}
age_party_graph
```

```{r age--party-ex-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-10-hint-1, eval = FALSE}
To change the label, you can use `scale_y_continuous`
```

```{r age--party-10-hint-2, eval = FALSE}
... %>% 
  labs(title = ...,
       subtitle = ...,
       x = ...,
       y = ...) %>% 
  scale_y_continuous(labels = scales::percent_format()) + 
  theme_classic()
```

### 

You have now created the posterior probability distribution for average age in relation to each party. Using this, we can answer the questions we began with pertaining to the relationship between age and party affiliation of train commuters.

This brings us to the Temperance virtue for our model of `age~party`. 

### Exercise 11

Let's start by recalling the first question.

*What is the probability that if a Democrat shows up to the train station, he will be over 50 years old?*

Using our fitted data, we can now attempt to answer this question and to do so, will make the following plot.

```{r echo = FALSE}
age_dem <- pp %>% 
  ggplot(aes(x = `1`)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   bins = 100)  +
    labs(title = "Posterior for a Random Democrat's Age",
         subtitle = "Individual predictions are always more variable than expected values",
         x = "Age",
         y = "Probability") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_classic()

age_dem
```

First make a new tibble with one observation of the `party set to the value of the "Democrat". Set this equal to `new_obs`.

```{r age--party-11, exercise = TRUE}

```

```{r age--party-11-hint-1, eval = FALSE}
new_obs <- tibble(party = ...)
```

### Exercise 12

Next, let's use `posterior_predict()` to create draws from the posterior. Set the first argument to the model for which we are running our simulations, `fit_1`, and the second argument to `new_obs`. Additionally, make all of the columns into numeric vectors. Store this as `pp`.

```{r age--party-12, exercise = TRUE}

```

```{r age--party-12-hint-1, eval = FALSE}
Remember to use as_tibble() to convert the result to a tibble as well as mutate() to change the results to numbers.
```

```{r age--party-12-hint-2, eval = FALSE}
pp <- posterior_predict(..., newdata = ...) %>% 
  as_tibble() %>% 
  mutate_all(as.numeric)
```

### Exercise 13

Now, let's plot this. Map the column representing age to the x-axis. Then use geom_histogram and use `aes()` in as the first argument to make the y-axis represent the probability. To do so, use `aes(y = after_stat(count/sum(count)))` as the first argument. Additionally, set `bins` to 100.

```{r age--party-13, exercise = TRUE}

```

```{r age--party-13-hint-1, eval = FALSE}
Remember that columns aren't named, so since age is in the first column, the x argument would need to be set at `1`. 
```

```{r age--party-13-hint-2, eval = FALSE}
pp %>% 
  ggplot(aes(x = `1`)) +
  geom_histogram(aes(y = after_stat(count/sum(count))),
                bins = ...)
```

### Exercise 14

Now, add a labels, make the scale for the y-values into percent-format, and add `theme_classic()`.

Recall, your result should appear similar to the following:

```{r echo = FALSE}
age_dem
```

```{r age--party-14, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-14-hint-1, eval = FALSE}
... +
  labs(title = "...",
       subtitle = "...",
       x = "...",
       y = "...") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_classic()
```

Now that we have the posterior distribution, we can determine the probability the next Democrat will be over 50. 

### Exercise 15

In order to do so, use the posterior distribution and sum up the values in which the age is greater than 50. Then divide this value by the number of rows there are.

```{r age--party-15, exercise = TRUE}

```

```{r age--party-15-hint-1, eval = FALSE}
sum(pp$`1` > 50) / nrow(pp)
```

### 

Therefore, the probability that the next Democrat will be over 50 is around 28%. 

<!-- MM: Change that answer so it isn't hardcoded -->

### Exercise 16

Next, let's consider the second question. 

*In a group of three Democrats and three Republicans, what will the age difference be between the oldest Democrat and the youngest Republican?*

To answer this, we will create the following plot.

```{r}
newobs <- tibble(party = c("Democrat", "Democrat", "Democrat", 
                        "Republican", "Republican","Republican"))

pp <- posterior_predict(fit_1, newdata = newobs) %>%
    as_tibble() %>%
    mutate_all(as.numeric) %>% 
    set_names(c("dem_1", "dem_2", "dem_3", 
                "rep_1", "rep_2", "rep_3")) %>% 
    rowwise() %>% 
    mutate(dems_oldest = max(c_across(dem_1:dem_3)),
           reps_youngest = min(c_across(rep_1:rep_3)),
           age_diff = dems_oldest - reps_youngest)
```

```{r}
age_diff_graph <- pp %>%  
  ggplot(aes(x = age_diff)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   bins = 100) +
    labs(title = "Posterior for Age Difference",
         subtitle = "Oldest of three Democrats compared to youngest of three Republicans",
         x = "Age",
         y = "Probability") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_classic()

age_diff_graph
```

Since our group has three Democrats and three Republicans, make a tibble with the observations of the column "party" that we desire. Store this as `new_obs`.



```{r age--party-16, exercise = TRUE}

```

```{r age--party-16-hint-1, eval = FALSE}
newobs <- tibble(party = c(...))
```

```{r age--party-16-hint-2, eval = FALSE}
newobs <- tibble(party = c("Democrat", "Democrat", "Democrat", 
                           "Republican", "Republican","Republican"))
```

### 

When doing this, ensure that the column names and the observations align with those of the original data set.

### Exercise 17

Now use posterior predict and make the values numeric vectors in order to create the posterior distribution. Remember to use our first argument as the fitted model `fit_1` we created earlier and the `newdata` equal to `newobs`.

```{r age--party-17, exercise = TRUE}

```

```{r age--party-17-hint-1, eval = FALSE}
posterior_predict(..., newdata = ...) %>%
    as_tibble() %>%
    mutate_all(as.numeric)
```

### Exercise 18

Currently your posterior predict has numbered columns correlating to the order in which we made the columns in `newobs`. Set the names to "dem_1", "dem_2", "dem_3", "rep_1", "rep_2", and "rep_3", respectively.

```{r age--party-18, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-18-hint-1, eval = FALSE}
Use the method set_names().
```

```{r age--party-18-hint-2, eval = FALSE}
set_names(c(..., ..., ..., ..., ..., ...))
```

### 

While the above step may not be necessary and we could proceed with the numbered columns, renaming makes it easier for us to use the distribution since it makes the columns more clear to us.

### Exercise 19

Next, group the data by row. Then, create a column `dems_oldest` that has the oldest aged 
Democrat in the row, a column `reps_youngest` with the youngest aged Republican in the row, and a column `age_diff` for the difference between the oldest Democrat and the youngest Republican in this row. Store this as `pp` and print the result.

```{r age--party-19, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-19-hint-1, eval = FALSE}
Recall the methods `max()` and `min()`. Also, `c_across()` can be used to create a list across columns.
```

```{r age--party-19-hint-2, eval = FALSE}
... %>% 
  rowwise() %>% 
  mutate(dems_oldest = max(c_across(...)),
         reps_youngest = min(c_across(...)),
         age_diff = dems_oldest - reps_youngest)
```

### 

In doing so, we have found the posterior distribution for the age difference between the oldest Democrat and youngest Republican for train commuters with a group of three Democrats and three Republicans.

### Exercise 20

Let's plot this. Start by using `ggplot` and mapping the the age difference to the x-axis. Then, add the layer geom_histogram and use `aes()` within the first argument to set the y-value to be the probability. Additionally, set the second argument `bins` equal to 100.

```{r age--party-20, exercise = TRUE}

```

```{r age--party-20-hint-1, eval = FALSE}
pp %>% 
  ggplot(aes(x = ...)) + 
  geom_histogram(aes(y = after_stat(count/sum(count))),
                 bins = ...)
```

### Exercise 21

Continue this pipe by adding labels. Then change the y-axis to be in percent_format and add the layer `theme_classic()`.

Remember, your plot should look something like this:

```{r echo = FALSE}
age_diff_graph
```

```{r age--party-21, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r age--party-21-hint-1, eval = FALSE}
... +
  labs(...) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_classic()
```

### 

With the posterior age difference model, we can now go on to answer our question.

### Exercise 22

Use the distribution to approximate what we would expect the age difference to be between the oldest Democrat and youngest Republican in a group of train commuters with 6 Democrats and 6 Republicans.

```{r age--party-22}
question_text(NULL,
	message = "As can be seen by the above distribution, we would expect the age difference to be about 22 years.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### 

As we have seen, through the use of our fitted data and `posterior_predict()`, we were able to answer our questions regarding age and party.

Let's continue this process with our questions pertaining to immigration attitude and exposure to Spanish-speakers.

## att_end ~ treatment

Recall our third and fourth questions:

*What is the average treatment effect, of exposing train commuters to Spanish-speakers, on their attitudes toward immigration?*

*What is the largest causal effect of exposing train commuters to Spanish-speakers which still has a 1 in 10 chance of occurring?*

Unlike our previous model, this will be a causal model since the treatment of being exposed to Spanish-speakers may cause a change in immigration attitudes, unlike how changing party registration will have no effect on age.

### Exercise 1

First, is the data representative of the population? Think specifically in terms of `att_end` and `treatment`. 

```{r attend--treatment-1}
question_text(NULL,
	message = "One point you may consider is how these may have changed over time. An additional point of discussion could be the location of Boston compared to other locations, such as those with a different sized Spanish-speaking population.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 2

```{r}
fit_2 <- stan_glm(att_end ~ treatment - 1, 
                      data = trains, 
                      seed = 45,
                      refresh = 0)
```

Now, that we have considered the Justice virtue, let's continue to Courage and make our fitted model using `stan_glm()`.  

Set your outcome variable as `att_end`and your explanatory variable as `treatment` (Remember you must insert a tilde `~` between the two). Also, include a `-1` after `treatment` so we do not get an intercept.  Set `data` to `trains`, and `refresh` to 0. Set this to the `fit_2` and print it out.

```{r attend--treatment-2, exercise = TRUE}

```

```{r attend--treatment-2-hint-1, eval = FALSE}
fit_2 <- stan_glm(... ~ ... -1,
                  data = ...
                  refresh = ...)
```

### 

Now, let's look at the posterior distributions for those who were treated and those who weren't.

### Exercise 3

To do so, we will make the following plot.

```{r}
treat_post <- fit_2 %>% 
  as_tibble() %>% 
  select(-sigma) %>% 
  pivot_longer(cols = treatmentTreated:treatmentControl,
               names_to = "Parameter",
               values_to = "attitude") %>% 
  ggplot(aes(x = attitude, fill = Parameter)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   alpha = 0.5, 
                   bins = 100, 
                   position = "identity") +
    labs(title = "Posterior for Expected Attitude Toward Immigration",
         subtitle = "Treated individuals are more conservative",
         x = "Attitude",
         y = "Probability") +
    scale_y_continuous(labels = scales::percent_format()) + 
    theme_classic()

treat_post
```

First, make `fit_2` into a tibble and get rid of `sigma` since it is not of importance to us. Remember that you need to use `as_tibble()`.

```{r attend--treatment-3, exercise = TRUE}

```

```{r attend--treatment-3-hint-1, eval = FALSE}
fit_2 %>% 
  as_tibble() %>% 
  select(...)
```

### Exercise 4

Next, use `pivot_longer()` with the argument of `cols` set to the "treatmentTreated" and "treatmentControl". Set the argument `names_to` to "Parameter", and `values_to` to "attitude".

```{r attend--treatment-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r attend--treatment-4-hint-1, eval = FALSE}
... %>% 
  pivot_longer(cols = ...,
               names_to = ...
               values_to = ...)
```

### Exercise 5

Let's plot this.  Map `attitude` on the x-axis and set `fill` to `Parameter`. Add the layer `geom_histogram()` and make y into a probability. Set `alpha` to 0.5, `bins` to 100, and `position` to "identity".

```{r attend--treatment-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r attend--treatment-5-hint-1, eval = FALSE}
... %>% 
  ggplot(aes(x = ..., y = ...)) + 
  geom_histogram(aes(y = after_stat(count/sum(count))),
                 alpha = ...,
                 bins = ...
                 position = ...)
```

### Exercise 6

Next, add labels, change the y-scale to be in a percent format and add the layer `theme_classic()`.

The posterior should appear similar to the following:

```{r}
treat_post
```

```{r attend--treatment-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r attend--treatment-6-hint-1, eval = FALSE}
... +
  labs(...) + 
  scale_y_continous(labels = scales::percent_format()) + 
  theme_classic()
```

### 

Now, using this posterior distribution, we can go on to answer the questions that we began this section with. 

### Exercise 7

Recall our first question pertaining to this distribution:

*What is the average treatment effect, of exposing people to Spanish-speakers, on their attitudes toward immigration?*

To help us answer this, we will make the following plot.

```{r}
newobs <- tibble(treatment = c("Treated", "Control"))

pe <- posterior_epred(fit_2, newobs) %>% 
    as_tibble() %>% 
    mutate(ate = `1` - `2`)

```

```{r}
ate_graph <- pe %>% 
  ggplot(aes(x = ate)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   bins = 100) +
    labs(title = "Posterior for Average Treatment Effect",
         subtitle = "Exposure to Spanish-speakers shifts immigration attitudes rightward",
         x = "Difference in Attitude",
         y = "Probability") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_classic()

ate_graph
```

Using the distribution, approximate the average treament effect.

```{r attend--treatment-7}
question_text(NULL,
	message = "Your answer should fall around 1.5",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 8



Now, let's use `posterior_epred()` to answer this question. Create a tibble like we have done before with our desired ovservations. For this scenario, call it `newobs` and set `treatment` having two values, "Treated" and "Control".

```{r attend--treatment-8, exercise = TRUE}

```

```{r attend--treatment-8-hint-1, eval = FALSE}
newobs <- tibble(treatment = c("Treated", "Control"))
```

### Exercise 9

Next, use `posterior_epred()` and set the first argument to our fitted model and the second to the tibble we just created. Remember we need to use `as_tibble()`.

```{r attend--treatment-9, exercise = TRUE}

```

```{r attend--treatment-9-hint-1, eval = FALSE}
posterior_epred(..., ...) %>% 
  as_tibble()
```

### Exercise 10

Continue this pipe and add a column `ate` for the average treatment effect. Set this to `pe`. 

Recall that the average treatment effect is the control value subtracted from the treated value.

```{r attend--treatment-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r attend--treatment-10-hint-1, eval = FALSE}
Remember that our columns are not titled, but are numbered and we need to use the format `1` to get the value from our first column.
```

```{r attend--treatment-10-hint-2, eval = FALSE}
pe <- ... %>% 
  mutate(ate = `1` - `2`)
```

### 

This results in the posterior probability distribution of average treatment effect.

### Exercise 11

Now, let's graph this. Map `ate` to the x-axis and add the layer `geom_histogram()`. Make the values on the y-axis probabilities and set the argument `bins` to 100. 

```{r attend--treatment-11, exercise = TRUE}

```

```{r attend--treatment-11-hint-1, eval = FALSE}
pe %>%
  ggplot(aes(x = ...)) + 
  geom_histogram(aes(y = after_stat(count/sum(count))),
                 bins = ...)
```

### Exercise 12

Next, add labels, format the values on the y-axis to be percents using `scale_y_continuous`, and add the layer `theme_classic()`.

The posterior should look similar to the following:

```{r}
ate_graph
```

```{r attend--treatment-12, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r attend--treatment-12-hint-1, eval = FALSE}
... + 
  labs(...) + 
  scale_y_continuous(labels = scales::percent_format()) +
  theme_classic()
```

### 

In creating the posterior distribution, we have effectively answered our first question to determine the average treatment.

### Exercise 13

```{r echo = FALSE}
pp <- posterior_predict(fit_2, 
                        newdata = newobs) %>%
    as_tibble() %>%
    mutate_all(as.numeric) %>% 
    mutate(te = `1` - `2`)
```

Now, let's take a look at our second question. 

*What is the largest effect size which still has a 1 in 10 chance of occurring?*

To answer this one, we will use `posterior_predict()` for two people, one who is treated and the other control. In other words, we can use the tibble `newobs` which we already created. Set the first argument to our fitted model and `newdata` to `newobs`. Make sure to use `as_tibble()` and to make all the values numeric as we have done previously.

```{r attend--treatment-13, exercise = TRUE}

```

```{r attend--treatment-13-hint-1, eval = FALSE}
posterior_predict(..., 
                  newdata = ...) %>%
  as_tibble() %>%
  mutate_all(as.numeric)
```

### Exercise 14

Continue this pipe and add a column `te` which is the difference between the treated person and the untreated person. Remember the columns are unnamed and that you must use numbers. Store this as `pp`.

```{r attend--treatment-14, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r attend--treatment-14-hint-1, eval = FALSE}
pp <- ... %>% 
  mutate(te = `1` - `2`)
```

### 

We have now created the posterior distribution for the treatment effect for one person. 

### Exercise 15

Let's now plot this and make the graph shown below. 

```{r echo = FALSE}
te_graph <- pp %>% 
  ggplot(aes(x = te)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   bins = 100)  +
    labs(title = "Posterior for Treatment Effect for One Person",
         subtitle = "Causal effects are more variable for indvduals",
         x = "Difference in Attitude",
         y = "Probability") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_classic()

te_graph
```

Map `te` to the x-axis and add the layer `geom_histogram()`. Make the values on the y-axis into probabilities and set the argument `bins` to 100.

```{r attend--treatment-15, exercise = TRUE}

```

```{r attend--treatment-15-hint-1, eval = FALSE}
pp %>% 
  ggplot(aes(x = ...)) +
  geom_histogram(aes(y = after_stat(count/sum(count))),
                 bins = ...)
```

### Exercise 16

Continue this pipe and add labels, format the y-axis to percents, and add the layer `theme_classic()`.

The result should appear similar to the following:
```{r echo = FALSE}
te_graph
```

```{r attend--treatment-16, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r attend--treatment-16-hint-1, eval = FALSE}
... +
  labs(...) + 
  scale_y_continuous(labels = scales::percent_format()) + 
  theme_classic()
```

### 

Using this distribution, we can evaluate the difference between treatment effect for a single individual and notice how large the spread is. To answer our question though, we need to look at the value at the 90th percentile since we are looking to find what the largest causal effect is that has a 1 in 10 chance of occurring.

### Exercise 17

In order to do so, we can use the function `quantile()`. To do so, select the `te` column of `pp` and use this as the first argument of `quantile()`. Set the second argument `prob` to our desired percentile, 0.9.

```{r attend--treatment-17, exercise = TRUE}

```

```{r attend--treatment-17-hint-1, eval = FALSE}
quantile(pp$te, prob = 0.9)
```

### 

As you can see above, the largest treatment effect that will occur about 10% of the time is 6.6

<!-- MM: Don't hardcode that -->

## income ~ age

Let's continue to answering our fifth question pertaining to the relationship between income and age. Recall our question.

*What would you expect the income to be for a 40-year old train commuter?*

Unlike previous question we have dealt with regarding predictive modeling, the predictor variable income is continuous in that there are a range of varying incomes as opposed to only having two options of "Democrat" and "Republican as we did in our model of party ~ age.

### Exercise 1

First, let's make our fitted model using `stan_glm()`. Set your outcome variable to `income` and your explanatory variable to `age`. Set data to `trains` and refresh to `0`. Store this as `fit_3`.

```{r income--age-1, exercise = TRUE}

```

```{r income--age-1-hint-1, eval = FALSE}
fit_3 <- stan_glm(income ~ age,
                  data = ...
                  refresh = ...)
```

```{r echo = FALSE}
fit_3 <- stan_glm(income ~ age, 
                  data = trains, 
                  seed = 28,
                  refresh = 0)

```

### Exercise 2

Now that we have made our fitted model, let's make our posterior distribution. Start by making a tibble `newobs` with the observation `age` is equal to 40.

```{r income--age-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r income--age-2-hint-1, eval = FALSE}
newobs <- tibble(age = 40)
```

```{r echo = FALSE}
newobs <- tibble(age = 40)
```

### Exercise 3

Now, recall that `posterior_epred()` is used when looking for expected values such as in this case. Therefore, use `posterior_epred()` with the first argument as our fitted model `fit_3` and the `newdata` argument as `newobs`. Remember to use `as_tibble()`. Store this as `pe`.

```{r income--age-3, exercise = TRUE}

```

```{r income--age-3-hint-1, eval = FALSE}
pe <- posterior_epred(..., newdata = ...) %>% 
  as_tibble()
```

```{r echo = FALSE}
pe <- posterior_epred(fit_3, newdata = newobs) %>% 
  as_tibble() 
```

### 

Now that we have the posterior for expected income, let's plot it.

### Exercise 4

We will be making the graph shown below.

```{r}
income_post <- pe %>% 
  ggplot(aes(x = `1`)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   bins = 100)  +
    labs(title = "Posterior for Expected Income",
         subtitle = "A 40-years old commuter earns around $140,000",
         x = "Income",
         y = "Probability") +
    scale_x_continuous(labels = scales::dollar_format()) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_classic()

income_post
```

Map the column for income to the x-axis. Then add the layer `geom_histogram()` and make y-value a probability. Additionally, make the argument `bins` equal to 100. 

```{r income--age-4, exercise = TRUE}

```

```{r income--age-4-hint-1, eval = FALSE}
Remember that the columns are unnamed so you will have to call them using numbers.
```

```{r income--age-4-hint-2, eval = FALSE}
pe %>% 
  ggplot(aes(x = `1`)) +
  geom_histogram(aes(y = after_stat(count/sum(count))),
                 bins = ...)
```

### Exercise 5

Now add labels to the graph and format the x-values to be in dollar-format and the y-values to be percent-format. Also, add the layer `theme_classic()`.

The posterior should appear similar to the following:
```{r echo = FALSE}
income_post
```

```{r income--age-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r income--age-5-hint-1, eval = FALSE}
... +
  labs(...) +
  scale_x_continuous(labels = scales::dollar_format()) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_classic()
```

### Exercise 6

Using the above distribution, estimate about how much a 40-year old train commuter would earn.

```{r income--age-6}
question_text(NULL,
	message = "They would earn around $140,000.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### 

While this may have been different from the previous predictive models we have worked with since income is a continuous scale, you can see that the process which we used to answer the question did not change.

## liberal ~ income

Now, let's move on to our final two questions.

*Among all people who have an income $100,000, what proportion are liberal?*

*Assume we have a group of eight people, two of whom make $100,000, two $200,000, two $300,000 and two $400,000. How many will be liberal?*

### Exercise 1

First determine the type of model this is as well as the outcome variable.

```{r liberal--income-1}
question_text(NULL,
	message = "This is a predictive model with `liberal` as the outcome variable.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### 

While this model is predictive like some others that we have done, it differs from those in that the outcome variable is not continuous. In the past three models, we have had outcome variables of `age`, `att_end`, and `income`, all of which have a range of values. 

In this model, however, the outcome variable is `liberal` which only has values of TRUE and FALSE. Therefore, when we modeling, we must use the `binomial` family.

### Exercise 2

Now, before we make this model, consider the validity of the data. Discuss your beliefs on the validity of `income` and `liberal`.

```{r liberal--income-2}
question_text(NULL,
	message = "While your beliefs may differ, one points to consider are if income now signifies the same thing it did in 2012. Similarly, consider if being `liberal` now means the same thing as it did in 2012.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	options = list(nrows = 6))
```

### Exercise 3

Let's now fit our model. Use `stan_glm()` and in the first argument, set the explanatory variable to `income` and the outcome variable to `liberal`. Use the data set `trains` and set `refresh` to 0. Additionally, recall that `liberal` only has two possible values, so set `family` to `binomial`. Store this as `fit_4` and print your results.

```{r liberal--income-3, exercise = TRUE}

```

```{r liberal--income-3-hint-1, eval = FALSE}
fit_4 <- stan_glm(liberal ~ income,
                  data = ..., 
                  family = ...,
                  refresh = ...)
```

```{r echo = FALSE}
fit_4 <- stan_glm(liberal ~ income,
                  data = trains, 
                  family = binomial,
                  refresh = 0)
```

### Exercise 4

With our fitted model, we can proceed to answer our questions. Recall our first question for this relationship:

*Among all people who have an income $100,000, what proportion are liberal?*

Like always, to answer the question, we must first make a tibble with the observations we desire. In this case, make a tibble with `income` set to 100000, and store this as `newobs`.

```{r liberal--income-4, exercise = TRUE}

```

```{r liberal--income-4-hint-1, eval = FALSE}
newobs <- tibble(income = ...)
```

```{r echo = FALSE}
newobs <- tibble(income = 100000)
```

### Exercise 5

Now, in order to get our posterior distribution, let's use `posterior_epred()` with the first argument as our fitted model, `fit_4`, and the second argument `newdata` as `newobs`. Remember to make this a tibble as well. Store this as `pe`.

```{r liberal--income-5, exercise = TRUE}

```

```{r liberal--income-5-hint-1, eval = FALSE}
pe <- posterior_epred(..., newdata = ...) %>% 
  as_tibble()
```

```{r echo = FALSE}
pe <- posterior_epred(fit_4, newdata = newobs) %>% 
  as_tibble()
```

### Exercise 6

Print out `pe`.

```{r liberal--income-6, exercise = TRUE}

```

```{r liberal--income-6-hint-1, eval = FALSE}
pe
```

### 

The population proportion is the same as the probability for any single individual.

### Exercise 7

Now that we have made our posterior distribution, let's plot it by making the following graph.

```{r echo = FALSE}
postlib <- pe %>% 
  ggplot(aes(x = `1`)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   bins = 100)  +
  
    scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    labs(title = "Posterior for Proportion Liberal Among $100,000 Earners",
         subtitle = "The population proportion is the same as the probability for any individual",
         x = "Income",
         y = "Probability of Being Liberal") +
  theme_classic()

postlib
```

Start by making a pipe and using `ggplot()` to map the proportions to the x-axis. Add the layer `geom_histogram()` and use `aes(y = after_stat(count/sum(count)))` in order to make the y-axis a probability. Set the argument `bins` to 100.

```{r liberal--income-7, exercise = TRUE}

```

```{r liberal--income-7-hint-1, eval = FALSE}
Remember that your columns are not named, but numbered.
```

```{r liberal--income-7-hint-2, eval = FALSE}
pe %>% ggplot(aes(x = `1`)) + 
  geom_histogram(aes(y = after_stat(count/sum(count))),
                 bins = ...)
```

### Exercise 8

Now, format the x and y-axis to appear as percentages.

```{r liberal--income-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r liberal--income-8-hint-1, eval = FALSE}
Use `scale_x_continuous` and `scale_y_continuous`. Also, set `accuracy` to 1 in order to make the number an integer.
```

```{r liberal--income-8-hint-2, eval = FALSE}
... +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```

### Exercise 9

Next, add in labels and the layer `theme_classic()`. Remember that your graph should appear similar to the following:

```{r echo = FALSE}
postlib
```

```{r liberal--income-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r liberal--income-9-hint-1, eval = FALSE}
... + 
  labs(...) + 
  theme_classic().
```

### Exercise 10

Now that we've answered our first question, let's consider our second question.

*Assume we have a group of eight people, two of whom make $100,000, two $200,000, two $300,000 and two $400,000. How many will be liberal?*

In order to answer this question, let's first make our tibble with the desired observations. In this case, we would like to have 2 people who make $100,000, $200,000, $300,000, and $400,000 each. So, in our tibble, set income to these values. Store this as `newobs`.

```{r liberal--income-10, exercise = TRUE}

```

```{r liberal--income-10-hint-1, eval = FALSE}
`rep()` can be used to replicate items in the tibble.
```

```{r liberal--income-10-hint-2, eval = FALSE}
newobs <- tibble(income = c(rep(100000, 2),
                            rep(200000, 2),
                            rep(300000, 2),
                            rep(400000, 2)))
```

```{r echo = FALSE}
newobs <- tibble(income = c(rep(100000, 2),
                            rep(200000, 2),
                            rep(300000, 2),
                            rep(400000, 2)))
```

### Exercise 11

Now, let's make our posterior distribution. Stary by using `posterior_predict()` with the first argument as our fitted model `fit_4` and the second argument `newdata` set to `newobs`. Make this a tibble and convert the values to be numeric.

```{r liberal--income-11, exercise = TRUE}

```

```{r liberal--income-11-hint-1, eval = FALSE}
posterior_predict(..., newdata = ...) %>% 
  as_tibble() %>% 
  mutates_all(as.numeric)
```

### Exercise 12

Continue that pipe by grouping the rows using `rowwise()`.

```{r liberal--income-12, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r liberal--income-12-hint-1, eval = FALSE}
... %>% 
  rowwise()
```

### Exercise 13

Now, like we have done before, we are going to add a total column which is the sum of the entire row since every individual who is liberal in our groupings is represented by a `1` and everyone who isn't is represented by a `0`, so the total will give us the number of liberals in the group. Store this as `pp`.

```{r liberal--income-13, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r liberal--income-13-hint-1, eval = FALSE}
You can use `c_across` to go across all the columns when taking the sum
```

```{r liberal--income-13-hint-2, eval = FALSE}
... %>% 
  mutate(total = sum(c_across()))
```

```{r echo = FALSE}
pp <- posterior_predict(fit_4, 
                        newdata = newobs) %>% 
  as_tibble() %>% 
  mutate_all(as.numeric) %>% 
  rowwise() %>% 
  mutate(total = sum(c_across()))
```

### Exercise 14

Now, let's plot this by making the below graph.

```{r}
lib_group <- pp %>% 
  ggplot(aes(x = total)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   bins = 100)  +
    labs(title = "Posterior for Number of Liberals in Group with Varied Incomes",
         subtitle = "Two is the most likely number, but values from 0 to 5 are plausible",
         x = "Number of Liberals",
         y = "Probability") +
    scale_x_continuous(labels = scales::number_format(accuracy = 1)) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    theme_classic()
```

Start by mapping `total` to the x-axis using `ggplot()` and add the layer `geom_histogram()`. Make the y-axis represent the probability rather than the count and set the argument `bins` to 100.

```{r liberal--income-14, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r liberal--income-14-hint-1, eval = FALSE}
To make y a probability, use `aes(y = after_stat(count/sum(count)))` as the first argument of `geom_histogram()`.
```

```{r liberal--income-14-hint-2, eval = FALSE}
pp %>% 
  ggplot(aes(x = total)) %>% 
  geom_histogram(aes(y = after_stat(count/sum(count))),
                 bins = 100)
```

### Exercise 15

Now format the x and y axis so that x is an integer and y is a percentage. Use `scale_x_continuous` and `scale_y_continous` to do so.

```{r liberal--income-15, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r liberal--income-15-hint-1, eval = FALSE}
... + 
  scale_x_continuous(labels = scales::number_format(accuracy = 1)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```

### Exercise 16

Now, add labels and layer `theme_classic()` in order to complete the graph. It should appear similar to the following.

```{r echo = FALSE}
lib_group
```

```{r liberal--income-16, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r liberal--income-16-hint-1, eval = FALSE}
... +
  labs(...) + 
  theme_classic()
```

### 

Through this posterior, it can be seen that it is most likely to have 2 liberals in this group with various incomes.

```{r download-answers, child = "../../child_documents/download_answers.Rmd"}
```
