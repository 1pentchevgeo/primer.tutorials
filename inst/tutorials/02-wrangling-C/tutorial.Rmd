---
title: "Wrangling C"
tutorial:
  id: "wrangling-c"
output:
  learnr::tutorial:
      progressive: true
      allow_skip: true
runtime: shiny_prerendered
description: "Chapter 2: Wrangling -- C"
---

```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(lubridate)
library(stringr)
library(skimr)
library(primer.data)
library(ggdist)

knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 
library(ggthemes)
```

## Information
###

```{r information}
quiz(caption = "",
  question_text(
    "Name:",
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL),
  question_text(
    "Email:",
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL))
```

## National Health and Nutrition Survey
###

`nhanes` includes data from the "National Health and Nutrition Examination Survey," which contains the personal and physical information of 10,000 Americans from two surveys in 2009 and 2011.

###

Let's create the following plot.

```{r}
nhanes_p1 <- nhanes %>% 
  select(bmi, gender, depressed) %>% 
  drop_na(depressed, bmi) %>% 
  ggplot(aes(x = bmi, fill = gender)) +
  geom_histogram(alpha = .5, bins = 100, position = "identity") +
  facet_wrap(~ depressed) +
  coord_cartesian(xlim = c(16, 60)) +
  labs(title = "BMI and Days Depressed",
       subtitle = "Most participants did not feel depressed at all", 
       x = "BMI", 
       y = "Depression", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_classic() 

nhanes_p1
```

### Exercise 1

`skim()` the `nhanes` data set.

```{r nhanes1, exercise = TRUE}

```

```{r nhanes1-hint, eval = FALSE}
skim(...)
```

###

Note that gender has no missing values. 

### Exercise 2

Now `select()` the `gender`, `depressed`, and `bmi` columns. 

```{r nhanes2, exercise = TRUE}

```

```{r nhanes2-hint, eval = FALSE}
... %>%
  select(..., ..., ...)
```

### Exercise 3

`nhanes` has NA values in some rows. Start a pipe with `nhanes`. Use `drop_na()` with the arguments `bmi`and `depressed` to remove all rows with a value of NA in the those columns.

```{r nhanes3, exercise = TRUE}

```

```{r nhanes3-hint, eval = FALSE}
... %>%
  drop_na(..., ...)
```

### Exercise 4

Continue your pipe with `ggplot()`. Add the layer `geom_histogram()`. Map `bmi` to the x-axis, and `gender` to `fill`.

```{r nhanes4, exercise = TRUE}

```

```{r nhanes4-hint-1, eval = FALSE}
... %>% 
  ggplot(data = ..., aes(x = ..., 
                        fill = ...)) +
  geom_histogram()
```

### 

Remember that histogram has a default `y` which are the counts it tabulates for each bin from our data. 

### Exercise 5

Within geom_histogram, set the argument `position` equal to "identity", set the argument `alpha` = `0.5`, and set the argument `bins` = 100. 

```{r nhanes5, exercise = TRUE}

```

```{r nhanes5-hint-1, eval = FALSE}
... %>% 
  geom_histogram(position = "identity", alpha =  ..., 
                        bins = ...)) 
```

###

For histogram and bar plots, `position` is by default "stacked", which stacks different colors of the same x value on top of one another. position being equal to "idenitity", makes it so that different colors overlap, which can be seen when the opacity of the colors is increased. 

### Exercise 6

Continue your pipe and add the layer `coord_cartesian` and  set the argument `xlim` equal to the vector `c(16, 60)`, which limits the x-axis domain to a minimum of 16 and a maximum of 60. 

```{r nhanes6, exercise = TRUE}

```

```{r nhanes6-hint-1, eval = FALSE}
... %>% 
  geom_histogram(position = "identity", alpha =  ..., 
                        bins = ...)) 
```

### Exercise 7

Continue your pipe and add the layer `facet_wrap()` to facet our histogram by `depressed`. 

```{r nhanes7, exercise = TRUE}

```

```{r nhanes7-hint-1, eval = FALSE}
Within facet_wrap(), remember to put a ~ before the variable you want to facet by.
```

```{r nhanes7-hint-2, eval = FALSE}
... + 
  facet_wrap(...) +
  theme_classic()
```

### 

### Exercise 8

Adjust the feel of the graph by adding the theme `theme_classic()`.

```{r nhanes8, exercise = TRUE}

```

```{r nhanes8-hint-1, eval = FALSE}
Recall that when you add a theme, you add a layer! Use the + operator.
```

```{r nhanes8-hint-2, eval = FALSE}
... +
  theme_clean()
```

###

Facet wrapping keeps the same y axis scale, which allows us to compare the sizes of data we have for each level of Depressed

### Exercise 9

To finish your plot, use `labs()` to give the graph a title, subtitle, axis labels, legend heading, and caption of your choice. To change the legend heading from the name of the tibble column, set the argument `fill` = "..."

```{r nhanes9, exercise = TRUE}

```

```{r nhanes9-hint-1, eval = FALSE}
labs(... ,
     fill = "...",
     ...)
```
Reminder: This is what your plot should look like.

```{r nhanes9-answer}
nhanes_p1
```

### Exercise 10

In the exercise below is code which creates the previous plot. While it allowed us to compare the amounts of data across groups, the different height scales did not allow easy comparison of the shape of each distribution across groups.

###

Let's make the following plot.

```{r}
nhanes_p2 <- nhanes %>% 
  select(bmi, gender, depressed) %>% 
  drop_na(depressed, bmi) %>% 
  ggplot(aes(x = bmi, fill = gender)) +
  geom_density(alpha = .5)  +
  facet_wrap(~ depressed) +
  coord_cartesian(xlim = c(16, 60)) +
  labs(title = "BMI and Days Depressed",
       subtitle = "Most depressed females heavier than most depressed males", 
       x = "BMI", 
       y = "Probability", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_classic() 

nhanes_p2
```

###

First remove the layer `geom_histogram()` and replace it with `geom_density()`. Set `alpha` = .5.

```{r nhanes10, exercise = TRUE}
 nhanes %>% 
  select(bmi, gender, depressed) %>% 
  drop_na(depressed, bmi) %>% 
  ggplot(aes(x = bmi, fill = gender)) +
  geom_histogram(alpha = .5, bins = 100, position = "identity") +
  facet_wrap(~ depressed) +
  coord_cartesian(xlim = c(16, 60)) +
  labs(title = "BMI and Days Depressed",
       subtitle = "Most participants did not feel depressed at all", 
       x = "BMI", 
       y = "Count", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_classic() 
```

```{r nhanes10-hint, eval = FALSE}
... +
  geom_density(alpha = ...) +
  ...
```

###

A density plot is a smoothed-out histogram. Also, instead of tabulating raw counts as the histogram does, a density plot tabulates counts relative to the total number counted (for each facet). This is what makes each histogram of the three histograms to be of comparable height.

### Exercise 11

Copy and paste the code above. Now within the layer `labs()`, set `y` from "Count" to "Probability". Also, set the subtitle to state an observation this graph allows us to more clearly see.

```{r nhanes11, exercise = TRUE}

```

```{r nhanes11-hint, eval = FALSE}
... +
  labs(title = "BMI and Days Depressed",
       subtitle = "...", 
       x = "BMI", 
       y = "...", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  ...
```

### Exercise 12

In the exercise below is code which creates the previous plot. While it allowed us to compare the shape of the each distribution across groups, a single x axis would allow us to more easily see what is happening at a particular BMI through all the graphs. 

###

Let's make the following plot.

```{r}
nhanes_p3 <- nhanes %>% 
  select(bmi, gender, depressed) %>% 
  drop_na(depressed, bmi) %>% 
  ggplot(aes(x = bmi, y = depressed, fill = gender)) +
  stat_slab(alpha = .5)  +
  coord_cartesian(xlim = c(16, 60)) +
  scale_y_discrete(labels = c("No Days", "Several Days", "Most Days")) +
  labs(title = "BMI and Days Depressed",
       subtitle = "Most often depressed females of higher BMI than most often depressed males", 
       x = "BMI", 
       y = "Days Depressed", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_classic() 

nhanes_p3
```

###

 First remove the layer `geom_density()` and replace it with `stat_slab()`. Set `alpha` = .5.
 
```{r nhanes12, exercise = TRUE}
 nhanes %>% 
  select(bmi, gender, depressed) %>% 
  drop_na(depressed, bmi) %>% 
  ggplot(aes(x = bmi, fill = gender)) +
  geom_density(alpha = .5)  +
  facet_wrap(~ depressed) +
  coord_cartesian(xlim = c(16, 60)) +
  labs(title = "BMI and Days Depressed",
       subtitle = "Most often depressed females have highest increase in BMI compared to same-sex peers", 
       x = "BMI", 
       y = "Probability", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_classic()  
```

```{r nhanes12-hint, eval = FALSE}
... +
  geom_density(alpha = ...) +
  ...
```

###

### Exercise 13

Remove the layer `facet_wrap`. Within `ggplot()`, map `depressed` to the y-axis

```{r nhanes13, exercise = TRUE}

```

```{r nhanes13-hint, eval = FALSE}
  ggplot(aes(..., y = "...", ...)
```

### Exercise 14

Add the layer `scale_y_discrete()`. Set the argument `labels` equal to a vector of strings `c("No Days, " Several Days", "Most Days")`. 

```{r nhanes14, exercise = TRUE}

```

```{r nhanes14-hint-1, eval = FALSE}
  ... +
  scale_y_discrete(labels = ...) +
  ... +
```

```{r nhanes14-hint-2, eval = FALSE}
  ... +
  scale_y_discrete(labels = c("No Days", "Several Days", "Most Days")) +
  ... +
```

### 

The vector renames the y-axis breaks from bottom to top based on the respective names given in the vector.
We use discrete because the y-axis measures discrete, as opposed to continuous or binned, variables.

### Exercise 15

Copy and paste the code above. Now within the layer `labs()`, set `y` from "Probability" to "" (blank). Also, set the subtitle to state an observation this graph allows us to more clearly see.

```{r nhanes15, exercise = TRUE}

```


```{r nhanes15-hint-1, eval = FALSE}
... +
  labs(title = "BMI and Days Depressed",
       subtitle = "...", 
       x = "BMI", 
       y = "", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  ...
```

## Submit

```{r context = "setup"}
submission_ui
```

```{r context = "server"}
submission_server()
```

```{r}
plots <- shaming %>% 
  mutate(id = 1:length(primary_06)) %>% 
  pivot_longer(cols = primary_00:general_04,
               names_to = "year",
               values_to = "voted") %>% 
  mutate(voted = if_else(voted == "Yes", 1, 0)) %>% 
  pivot_wider(names_from = year, 
              values_from = voted) %>% 
  rowwise() %>% 
  mutate(vote_sum = sum(primary_00, general_00, primary_02, general_02, primary_04, general_04)) %>% 
  select(age, vote_sum, primary_06) %>% 
  drop_na() %>% 
  ggplot(aes(age, vote_sum, fill = primary_06)) +
  stat_slab(alpha = 0.5)


```

```{r}
mutate(age_groups = case_when(age >= 18 & age < 30 ~ "18-30",
            age >= 30 &  age < 45  ~ "30-45",
            age >= 45 & age < 65 ~ "45-60",
            age >= 65 ~ "65 +")
```

