---
title: "Wrangling C"
tutorial:
  id: "wrangling-c"
output:
  learnr::tutorial:
      progressive: true
      allow_skip: true
runtime: shiny_prerendered
description: "Chapter 2: Wrangling -- C"
---

```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(lubridate)
library(stringr)
library(skimr)
library(primer.data)
library(ggdist)

knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 
library(ggthemes)
```


<!-- There is something wrong with this file, which is causing it to fail R CMD check. So, I renamed it to problem.Rmd. You can still Run Document the file and it works fine. But the fact that it is not named tutorial.Rmd means that our test script does not try (and fail) to test it. Good enough for now. -->

<!-- Start with a geom_histogram example, but which looks like a standard plot. Or, maybe just use facet_wrap, stack them on top of each other. Raw counts of things are important. -->

<!-- Second plot, use the same data, turns it into percentages using the after_stat() trickery. -->

<!-- Third plot, use the same data, does this with geom_density(). Just an easier way of showing those shapes. -->

<!-- Fourth plot, same data, use stat_slab().  -->

<!-- Next three plots use different data (with, one hopes, some wrangling) and then different stat_slab(). (At least one should be dot plots. And one should be vertical.) -->

<!-- Five examples, each of which needs to use pivot_longer (if needed) to put things in the same column and which then creates a "standard" plot with different levels on the y-axis. Those levels sometimes already exist in the data, like trains$party, and sometimes need to be created, like turning trains$income into 5 categories.  -->

<!-- Use stuff other than stat_slab() for variety sake. Use geom_density in the first plot, maybe. And then geom_histogram() in the second plot, maybe with the same data! -->

<!-- Drop knuggets of wisdom about what these densities mean. Sometimes they are scaled and sometimes not. -->

<!-- Example with trains which needs to get att_end and att_start in the same column so that you can plot them together with fill or whatever. -->

<!-- Example with trains which transform income into a set of categories, as in class.  -->

<!-- Change phrasing of joint ggplot geom exercises -->


## Information
###

```{r information}
quiz(caption = "",
  question_text(
    "Name:",
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL),
  question_text(
    "Email:",
    answer(NULL, correct = TRUE),
    allow_retry = TRUE,
    try_again_button = "Edit Answer",
    incorrect = NULL))
```

## National Health and Nutrition Survey
###

`nhanes` includes data from the "National Health and Nutrition Examination Survey," which contains the personal and physical information of 10,000 Americans from two surveys in 2009 and 2011.

###

Let's create the following plot.

```{r make-nhanes}
nhanes_p1 <- nhanes %>% 
  select(bmi, gender, depressed) %>% 
  drop_na(depressed, bmi) %>% 
  ggplot(aes(x = bmi, fill = gender)) +
  geom_histogram(alpha = .5, bins = 100, position = "identity") +
  facet_wrap(~ depressed) +
  coord_cartesian(xlim = c(16, 60)) +
  labs(title = "BMI and Days Depressed",
       subtitle = "Most participants did not feel depressed at all", 
       x = "BMI", 
       y = "Depression", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_classic() 

nhanes_p1
```

### Exercise 1

`skim()` the `nhanes` data set.

```{r nhanes1, exercise = TRUE}

```

```{r nhanes1-hint, eval = FALSE}
skim(...)
```

###

Note that depressed is a factor. 

### Exercise 2

Now `select()` the `gender`, `depressed`, and `bmi` columns. 


```{r nhanes2, exercise = TRUE}

```

```{r nhanes2-hint, eval = FALSE}
... %>%
  select(..., ..., ...)
```

### Exercise 3

`nhanes` has NA values in some rows. Start a pipe with `nhanes`. Use `drop_na()` with the arguments `bmi`and `depressed` to remove all rows with a value of NA in the those columns.

```{r nhanes3, exercise = TRUE}

```

```{r nhanes3-hint, eval = FALSE}
... %>%
  drop_na(..., ...)
  select(..., ..., ...)
```

### Exercise 4

Continue your pipe with `ggplot()`. Add the layer `geom_histogram()`. Map `bmi` to the x-axis, and `gender` to `fill`.

```{r nhanes4, exercise = TRUE}

```


```{r nhanes4-hint-1, eval = FALSE}
... %>% 
  ggplot(data = ..., aes(x = ..., 
                        fill = ...)) +
  geom_histogram()
```

### 

Remember that histogram has a default `y` which are the counts it tabulates for each bin from our data. 

### Exercise 5

Within geom_histogram, set the argument `position` equal to "identity", set the argument `alpha` = `0.5`, and set the argument `bins` = 100. 

```{r nhanes5, exercise = TRUE}

```

```{r nhanes5-hint-1, eval = FALSE}
... %>% 
  geom_histogram(position = "identity", alpha =  ..., 
                        bins = ...)) 
```

###

For histogram and bar plots, `position` is by default "stacked", which stacks different colors of the same x value on top of one another. position being equal to "idenitity", makes it so that different colors overlap, which can be seen when the opacity of the colors is increased. 

### Exercise 6

Add the layer `facet_wrap()` to facet the histogram by `depressed`. 

```{r nhanes6, exercise = TRUE}

```

```{r nhanes6-hint-1, eval = FALSE}
Within facet_wrap(), remember to put a ~ before the variable you want to facet by.
```

```{r nhanes6-hint-2, eval = FALSE}
... + 
  facet_wrap(...) 
```

### 

Facet wrapping keeps the same y axis scale, which allows us to compare the sizes of data we have for each level of Depressed

### Exercise 7

Add the layer `coord_cartesian` and  set the argument `xlim` equal to the vector `c(16, 60)`, which limits the x-axis domain to a minimum of 16 and a maximum of 60. 

```{r nhanes7, exercise = TRUE}

```

```{r nhanes7-hint-1, eval = FALSE}
... +
  coord_cartesian(xlim = c(...,...))
```

### Exercise 8

Adjust the feel of the graph by adding the theme `theme_clean()`.

```{r nhanes8, exercise = TRUE}

```

```{r nhanes8-hint-1, eval = FALSE}
Recall that when you add a theme, you add a layer! Use the + operator.
```

```{r nhanes8-hint-2, eval = FALSE}
... +
  theme_clean()
```

### Exercise 9

To finish your plot, use `labs()` to give the graph a title, subtitle, axis labels, legend heading, and caption. To change the legend heading from the name of the tibble column, set the argument `fill` = "..."

```{r nhanes9, exercise = TRUE}

```

```{r nhanes9-hint-1, eval = FALSE}
labs(... ,
     fill = "...",
     ...)
```
Reminder: This is what your plot should look like.

```{r nhanes9-answer}
nhanes_p1
```

### Exercise 10

The histogram plots the actual counts for each BMI bin, and the categories of Depressed with more data are taller. Other functions can plot probabilities for each bin, i.e. the count for each bin divided by the sum of the counts in all a graph's bin.

###

Let's make the following plot.

```{r make-nhanes2}
nhanes_p2 <- nhanes %>% 
  select(bmi, gender, depressed) %>% 
  drop_na(depressed, bmi) %>% 
  ggplot(aes(x = bmi, fill = gender)) +
  geom_density(alpha = .5)  +
  facet_wrap(~ depressed) +
  coord_cartesian(xlim = c(16, 60)) +
  labs(title = "BMI and Days Depressed",
       subtitle = "Most often depressed females heavier than most often depressed males", 
       x = "BMI", 
       y = "Density", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_classic() 

nhanes_p2
```

###

We have provided you with the beginning of code for the last plot. Continue your pipe with `ggplot()`. Add the layer `geom_density()`. Map `bmi` to the x-axis, and `gender` to `fill`. Within `geom_density()`, set `alpha` = .5.

```{r nhanes10, exercise = TRUE}
 nhanes %>% 
  select(bmi, gender, depressed) %>% 
  drop_na(depressed, bmi) %>% 
```

```{r nhanes10-hint, eval = FALSE}
... %>% 
ggplot(aes(..., fill = ...)) +
  geom_density(alpha = ...) 
```

###

In addition to plotting probabilities instead of counts, `geom_density()` smooths out the histogram. 

### Exercise 11

Copy and paste the code above. Add the layer `facet_wrap()` to facet the histogram by `depressed`. 

```{r nhanes11, exercise = TRUE}

```

```{r nhanes11-hint-1, eval = FALSE}
Within facet_wrap(), remember to put a ~ before the variable you want to facet by.
```

```{r nhanes11-hint-2, eval = FALSE}
... + 
  facet_wrap(...) 
```

### 

Facet wrapping keeps the same y axis scale, which allows us to compare the sizes of data we have for each level of Depressed

### Exercise 12

Add the layer `coord_cartesian` and  set the argument `xlim` equal to the vector `c(16, 60)`, which limits the x-axis domain to a minimum of 16 and a maximum of 60. 

```{r nhanes12, exercise = TRUE}

```

```{r nhanes12-hint-1, eval = FALSE}
... +
  coord_cartesian(xlim = c(...,...))
```

### Exercise 13

Now within the layer `labs()`, set `y` from "Count" to "Probability". Also, set the subtitle to state an observation this graph allows us to more clearly see. Finally, add `theme_clean()`. 

```{r nhanes13, exercise = TRUE}

```

```{r nhanes13-hint, eval = FALSE}
  ... +
  labs(title = "BMI and Days Depressed",
       subtitle = "...", 
       x = "BMI", 
       y = "...", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_clean()

```

Reminder: This is what your plot should look like.

```{r nhanes13-answer}
nhanes_p2
```

### Exercise 14

In the above, we have facet wrapped the graphs for the three Depressed categories. It would be easier to compare across the x-axis if the graphs were stacked. 

###

Let's make the following plot.

```{r make-nhanes3}
nhanes_p3 <- nhanes %>% 
  select(bmi, gender, depressed) %>% 
  drop_na(depressed, bmi) %>% 
  ggplot(aes(x = bmi, y = depressed, fill = gender)) +
  stat_slab(alpha = .5)  +
  coord_cartesian(xlim = c(16, 50)) +
  scale_y_discrete(labels = c("No Days", "Several Days", "Most Days")) +
  labs(title = "BMI and Days Depressed",
       subtitle = "Most often depressed femaes have highest BMI among both sexes", 
       x = "BMI", 
       y = "Days Depressed", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_classic() 

nhanes_p3
```

###

We have provided you with the beginning of code for the last plot. Continue your pipe with `ggplot()`. Add the layer `stat_slab()`. Map `bmi` to the x-axis, `depressed` to the y-axis, and `gender` to `fill`. Within `geom_density()`, set `alpha` = .5.

```{r nhanes14, exercise = TRUE}
 nhanes %>% 
  select(bmi, gender, depressed) %>% 
  drop_na(depressed, bmi) %>% 
```

```{r nhanes14-hint, eval = FALSE}
... %>% 
ggplot(aes(...,  ...., fill = ...)) +
  stat_slab(alpha = ...) 
```

###

Notice that adding `depressed` to the y-axis has done something similar to what faceting did in our previous graphs. This can be done with `stat_slab()` which is part of the package `ggdist`. 

### Exercise 15

Add the layer `coord_cartesian`. Let's alter our maximum to 50 so that we get a better focus on the peaks of the graph. Set `xlim` equal to the vector `c(16, 50)`, which limits the x-axis domain to a minimum of 16 and a maximum of 50. 

```{r nhanes15, exercise = TRUE}

```

```{r nhanes15-hint-1, eval = FALSE}
... +
  coord_cartesian(xlim = c(...,...))
```

### Exercise 16

Add the layer `scale_y_discrete()`. Set the argument `labels` equal to a vector of strings `c("No Days, " Several Days", "Most Days")`. 

```{r nhanes16, exercise = TRUE}

```

```{r nhanes16-hint-1, eval = FALSE}
  ... +
  scale_y_discrete(labels = ...) +
  ... +
```

```{r nhanes16-hint-2, eval = FALSE}
  ... +
  scale_y_discrete(labels = c("No Days", "Several Days", "Most Days")) +
  ... +
```

### 

The vector renames the y-axis breaks from bottom to top based on the respective names given in the vector.
We use discrete because the y-axis measures discrete, as opposed to continuous or binned, variables.

### Exercise 17

Copy and paste the code above. Now within the layer `labs()`, set `y` to "" so that there will be no y-axis label. Also, set the subtitle to state an observation this graph allows us to more clearly see. Finally, add `theme_clean()`. 

```{r nhanes17, exercise = TRUE}

```

```{r nhanes17-hint-1, eval = FALSE}
... +
  labs(title = "...",
       subtitle = "...", 
       x = "...", 
       y = "", 
       fill = "...",
       caption = "...") +
  theme_clean()
```

Reminder: This is what your plot should look like.

```{r nhanes17-answer}
nhanes_p3
```

###

Good work.

## Michigan Voter Experiment
###

The `shaming` data set measures the impact of social pressure on voting. Nearly 350,000 people in Michigan were randomly assigned to 1 of 5 treatment groups before the 2006 Michigan primary. All 5 groups were sent mail before the primary: the "Civic Duty" group had an extra reminder that voting was a civic responsibility, the "Hawthorne" group was told that whether or not they voted would be in the public record, the "Self" group was actually *sent* the public record of whether or not they voted in 2004, and the "Neighbors" group was sent both their voting record and their neighbors' voting record from 2004. 

### 

Let's create the following plot

```{r make-shaming1}
shaming_p1 <- shaming %>% 
  mutate(id = 1:length(primary_06)) %>% 
  pivot_longer(cols = primary_00:general_04,
               names_to = "year",
               values_to = "voted") %>% 
  mutate(voted = if_else(voted == "Yes", 1, 0)) %>% 
  pivot_wider(names_from = year, 
              values_from = voted) %>% 
  rowwise() %>% 
  mutate(vote_sum = sum(primary_00, general_00, primary_02, general_02, 
                        primary_04, general_04)) %>% 
  mutate(vote_sum = as.character(vote_sum),
         primary_06 = as.character(primary_06)) %>% 
  select(age, vote_sum, primary_06) %>% 
  ggplot(aes(x = age, fill = primary_06)) +
  geom_histogram(alpha = 0.5, bins = 30, position = "identity") +
  facet_wrap(~ vote_sum) + 
  coord_cartesian(xlim = c(20, 90)) +
  scale_fill_manual(values = c("#F8766D", "#00BFC4"), labels = c("Did not vote", "Voted")) +
  theme_classic() +
  labs(title = "Age Distributions by Voting History",
       subtitle = "Those who have voted more are more likely to vote in the 2006 primary", 
       x = "Age", 
       y = "Number of Times Voted", 
       fill = "Voted in 2006 Primary",
       caption = "Gerber, Green, and Larimer (2008)") 
shaming_p1
```

### Exercise 1

`skim()` the `shaming` data set.

```{r shaming1, exercise = TRUE}

```

```{r shaming1-hint, eval = FALSE}
skim(...)
```

###

Note that this data set has no missing values. 

### Exercise 2

Let's convert the voting records for the election before the 2006 primary into binary. To do so we will use `pivot_longer()` to transform the six columns into one column, make the change into binary, and then use `pivot_wider()` to transform the data back into the original format. However, because there does not exist a column that uniquely identifies each row, `pivot_wider()` cannot match data with the data that belonged to its original row. 

###

Let's create a variable that uniquely identifies each row. Begin a pipe from `shaming`. Use `mutate` to create the column `id`. Set this equal to the expression `1:length(primary_06)`, an expression for an integer series from one until the number of rows in the column `primary_06`. 

```{r shaming2, exercise = TRUE}

```

```{r shaming2-hint-1, eval = FALSE}
... %>% 
  mutate(id = ...)
```

```{r shaming2-hint-2, eval = FALSE}
... %>% 
  mutate(id = 1:length(primary_06))
```

###
By default, `pivot_wider()` attempts to use all columns to define unique rows. In many data sets, these columns provide uniquely identifying information on their own. 

### Exercise 3

Use `pivot_longer()` to combine the contents of the columns from `primary_00` to `general_04` into one column. Set the column names to go to a new column called `"election"` and the values to go to a column called, `"voted"`. 

```{r shaming3, exercise = TRUE}

```

```{r shaming3-hint-1, eval = FALSE}
... %>% 
  pivot_longer(cols = ...:...,
               ...)
```

```{r shaming3-hint-2, eval = FALSE}
pivot_longer(cols = primary_00:general_04,
               names_to = "...",
               values_to = "...")
```

### 

Because the columns we have selected are consecutive, we can use the `:` to more quickly name them as a group. Look at the `tidyr_tidy_select` page for more operators which make it easier to select variables. 

### Exercise 4

Use `mutate()` to change the `voted` column into a column of the same name, but which has `1` and `0` instead of `"Yes"` and `"No"`. Set `voted` equal to an `if_else()` function whose condition is `voted ==  "Yes"`. Set the results, for if true and false, to be `1` and `0`, respectively. 

```{r shaming4, exercise = TRUE}

```

```{r shaming4-hint-1, eval = FALSE} 
... %>% 
 mutate(voted = if_else(...))
```

```{r shaming4-hint-2, eval = FALSE}
... %>% 
 mutate(voted = if_else(...))
```

### Exercise 5

Use `pivot_wider()` to transform the contents of `voted` back into six columns. Set the names of these new columns to come from `election` and their values to come from `voted`. 

```{r shaming5, exercise = TRUE}

```

```{r shaming5-hint-1, eval = FALSE}  
... %>% 
pivot_wider(names_from = ..., 
              values_from = ...)
```

### 

Notice how quotes are not needed when referring to existing columns in `pivot_wider()`, but are needed when creating new columns in `pivot_longer()`.

### Exercise 6

Use `mutate()` to create a new column called `vote_sum`. Set this equal to the sum of the columns from `primary_00` to `general_04`.

```{r shaming6, exercise = TRUE}

```

```{r shaming6-hint-1, eval = FALSE}  
... %>% 
pivot_wider(names_from = ..., 
              values_from = ...)
```

### Exercise 7 

Add `rowwise()` to the pipe so that R performs the following mutate operation for each row. Use `mutate()` to change the `vote_sum` column into a column of the same name, whose contents are characters rather than numbers. Use the `as.character()` function. 

```{r shaming7, exercise = TRUE}

```

```{r shaming7-hint-1, eval = FALSE}  
rowwise() %>% 
mutate(... = as.character(...))
```

```{r shaming7-hint-2, eval = FALSE}  
rowwise() %>% 
mutate(vote_sum = as.character(vote_sum))
```

### 

Recall that we will be using these numbers which represent vote histories as different categories for our age distributions. When we put these on the y-axis in numeric form, ggplot gets confused because it thinks we are putting a continuous variable on the y-axis. 

### Exercise 8 

Select the columns relevant for our plot `age`, `vote_sum`, and `primary_06`.

```{r shaming8, exercise = TRUE}

```

```{r shaming8-hint-1, eval = FALSE}  
... %>% 
select(..., ..., ...)
```

### Exercise 9

Continue your pipe with `ggplot()`. Add the layer `geom_histogram()`. Map `age` to the x-axis, and `primary_06` to `fill`.

```{r shaming9, exercise = TRUE}

```

```{r shaming9-hint-1, eval = FALSE}
... %>% 
  ggplot(data = ..., aes(x = ..., 
                        fill = ...)) +
  geom_histogram()
```

### 

Remember that histogram has a default `y` which are the counts it tabulates for each bin from our data. 

### Exercise 10

Within geom_histogram, set the argument `position` equal to "identity", set the argument `alpha` = `0.5`, and set the argument `bins` = 30. 

```{r shaming10, exercise = TRUE}

```

```{r shaming10-hint-1, eval = FALSE}
... %>% 
  geom_histogram(position = "identity", alpha =  ..., 
                        bins = ...)) 
```

###

For histogram and bar plots, `position` is by default "stacked", which stacks different colors of the same x value on top of one another. `position` being equal to "identity", makes it so that different colors overlap, and that both can be seen when the opacity of the colors is increased. 

### Exercise 11

Add the layer `facet_wrap()` to facet the histogram by `vote_sum`. 

```{r shaming11, exercise = TRUE}

```

```{r shaming11-hint-1, eval = FALSE}
Within facet_wrap(), remember to put a ~ before the variable you want to facet by.
```

```{r shaming11-hint-2, eval = FALSE}
... + 
  facet_wrap(...) 
```

### Exercise 12

Add the layer `coord_cartesian` and  use the argument to limit the x-axis domain to a minimum of 20 and a maximum of 90 

```{r shaming12, exercise = TRUE}

```

```{r shaming12-hint-1, eval = FALSE}
... +
  coord_cartesian(xlim = c(...,...))
```

### Exercise 13

Add the layer `scale_fill_manual` to change the legend options from `0` and `1` to `Did not vote` and `vote`. The first argument is `values` which determines the fill colors, set this equal to `c("#F8766D", "#00BFC4")`, the default red and blue in ggplot. Set the second argument `labels` equal to `c("Did not vote", "Voted")`. 

```{r shaming13, exercise = TRUE}

```

```{r shaming13-hint-1, eval = FALSE}
... +
  scale_fill_manual(values = c("...", "..."), labels = c("...", "..."))
```

### Exercise 14

Adjust the feel of the graph by adding the theme `theme_clean()`. To finish your plot, use `labs()` to give the graph a title, subtitle, axis labels, legend heading, and caption.

```{r shaming14, exercise = TRUE}

```

```{r shaming14-hint-1, eval = FALSE}
labs(... ,
     fill = "...",
     ...)
```

Reminder: This is what your plot should look like.

```{r shaming14-answer}
nhanes_p1
```

### Exercise 15

Let's make the following plot, using density plots to visualize the same data.

```{r make-shaming2}
shaming_p2 <- shaming %>% 
  mutate(id = 1:length(primary_06)) %>% 
  pivot_longer(cols = primary_00:general_04,
               names_to = "year",
               values_to = "voted") %>% 
  mutate(voted = if_else(voted == "Yes", 1, 0)) %>% 
  pivot_wider(names_from = year, 
              values_from = voted) %>% 
  rowwise() %>% 
  mutate(vote_sum = sum(primary_00, general_00, primary_02, general_02, primary_04, general_04)) %>% 
  mutate(vote_sum = as.character(vote_sum),
         primary_06 = as.character(primary_06)) %>% 
  select(age, vote_sum, primary_06) %>% 
  ggplot(aes(x = age, fill = primary_06)) +
  geom_density(alpha = 0.3) +
  facet_wrap(~ vote_sum) + 
  coord_cartesian(xlim = c(20, 90)) +
  scale_fill_manual(values = c("#F8766D", "#00BFC4"), labels = c("Did not vote", "Voted")) +
  theme_classic() +
  labs(title = "Age Distributions by Voting History",
       subtitle = "Among those of the same voting history, those who voted in the 
2006 primary are of similar ages to those who did not", 
       x = "Age", 
       y = "Density", 
       fill = "2006 Primary",
       caption = "Gerber, Green, and Larimer (2008)") 
  
shaming_p2
```

###

We have provided you with the beginning of code for the last plot. Continue your pipe with `ggplot()`. Add the layer `geom_density()`. Map `age` to the x-axis, and `primary_06` to `fill`. Within `geom_density()`, set `alpha` equal to 0.3.

```{r shaming15, exercise = TRUE}
shaming %>% 
  mutate(id = 1:length(primary_06)) %>% 
  pivot_longer(cols = primary_00:general_04,
               names_to = "year",
               values_to = "voted") %>% 
  mutate(voted = if_else(voted == "Yes", 1, 0)) %>% 
  pivot_wider(names_from = year, 
              values_from = voted) %>% 
  rowwise() %>% 
  mutate(vote_sum = sum(primary_00, general_00, primary_02, general_02, primary_04, general_04)) %>% 
  mutate(vote_sum = as.character(vote_sum),
         primary_06 = as.character(primary_06)) %>% 
  select(age, vote_sum, primary_06) %>% 
```

```{r shaming15-hint, eval = FALSE}
... %>% 
  ggplot(aes(..., fill = ...)) +
  geom_density(alpha = ...) 
```

### Exercise 16

Copy and paste the code above. Add the layer `facet_wrap()` to facet the histogram by `vote_sum`. Add the layer `coord_cartesian` and  use the argument to limit the x-axis domain to a minimum of 20 and a maximum of 90. 

```{r shaming16, exercise = TRUE}

```

```{r shaming16-hint-1, eval = FALSE}
Within facet_wrap(), remember to put a ~ before the variable you want to facet by.
```

```{r shaming16-hint-2, eval = FALSE}
... +
  coord_cartesian(xlim = c(...,...))
```

### Exercise 17

Add the layer `scale_fill_manual` to change the legend options from `0` and `1` to `Did not vote` and `vote`. The first argument is `values` which determines the fill colors, set this equal to `c("#F8766D", "#00BFC4")`, the default red and blue in ggplot. Set the second argument `labels` equal to `c("Did not vote", "Voted")`. 

```{r shaming17, exercise = TRUE}

```

```{r shaming17-hint-1, eval = FALSE}
... +
  scale_fill_manual(values = c("...", "..."), labels = c("...", "..."))
```

### Exercise 18

Adjust the feel of your graph by adding `theme_clean()`. Finally, add labels to your graph. Pay particular attention to how the y-axis label and subtitle should change compared to the previous plot. 

```{r shaming18, exercise = TRUE}

```

```{r shaming18-hint, eval = FALSE}
  ... +
  labs(title = "BMI and Days Depressed",
       subtitle = "...", 
       x = "BMI", 
       y = "...", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_clean()

```

Reminder: This is what your plot should look like.

```{r shaming18-answer}
shaming_p2
```

### Exercise 19

Let's create the following plot, using another `ggdist` function to  visualize the same data with point interval graphs. 

```{r make-shaming3}
shaming %>% 
  mutate(id = 1:length(primary_06)) %>% 
  pivot_longer(cols = primary_00:general_04,
               names_to = "year",
               values_to = "voted") %>% 
  mutate(voted = if_else(voted == "Yes", 1, 0)) %>% 
  pivot_wider(names_from = year, 
              values_from = voted) %>% 
  rowwise() %>% 
  mutate(vote_sum = sum(primary_00, general_00, primary_02, general_02, primary_04, general_04)) %>% 
  mutate(vote_sum = as.character(vote_sum),
         primary_06 = as.character(primary_06)) %>% 
  select(age, vote_sum, primary_06) %>% 
  ggplot(aes(x = age, y = vote_sum, color = primary_06)) +
  stat_pointinterval(position = "dodge") +
  scale_color_manual(values = c("#F8766D", "#00BFC4"), labels = c("Did not vote", "Voted")) +
  theme_classic() +
  labs(title = "Age Distributions by Voting History",
       subtitle = "With the exception of the youngest, those who voted in the 2006
primary were always slightly older than those who did not", 
       x = "Age", 
       y = "Number of Times Voted",
       color = "2006 Primary",
       caption = "Gerber, Green, and Larimer (2008)") 

shaming_p3
```

###

The middle point represents the mean of the distribution, the bolded line represents the 25th to 75th percentile, the unbolded line represents the 5th to 95th percentiles. 

###

We have provided you with the beginning of code for the last plot. Continue your pipe with `ggplot()`.  Map `age` to the x-axis, and `primary_06` to `color`. Add the layer `geom_pointinterval()`.

```{r shaming19, exercise = TRUE}
shaming %>% 
  mutate(id = 1:length(primary_06)) %>% 
  pivot_longer(cols = primary_00:general_04,
               names_to = "year",
               values_to = "voted") %>% 
  mutate(voted = if_else(voted == "Yes", 1, 0)) %>% 
  pivot_wider(names_from = year, 
              values_from = voted) %>% 
  rowwise() %>% 
  mutate(vote_sum = sum(primary_00, general_00, primary_02, general_02, primary_04, general_04)) %>% 
  mutate(vote_sum = as.character(vote_sum),
         primary_06 = as.character(primary_06)) %>% 
  select(age, vote_sum, primary_06) %>% 
```

```{r shaming19-hint, eval = FALSE}
... %>% 
  ggplot(aes(..., color = ...)) +
  geom_pointinterval() 
```

###

We use `color` instead of `fill` since we are dealing with lines rather than filled shapes. 

### Exercise 20

Copy and paste the code above. Add the layer `coord_cartesian` and  use the argument to limit the x-axis domain to a minimum of 20 and a maximum of 81, since none of our distributions have a 95th percentile greater than 81.  

```{r shaming20, exercise = TRUE}

```

```{r shaming20-hint-1, eval = FALSE}
Within facet_wrap(), remember to put a ~ before the variable you want to facet by.
```

```{r shaming20-hint-2, eval = FALSE}
... +
  coord_cartesian(xlim = c(...,...))
```

### Exercise 21

Add the layer `scale_color_manual` to change the legend options from `0` and `1` to `Did not vote` and `vote`. The first argument is `values` which determines the fill colors, set this equal to `c("#F8766D", "#00BFC4")`, the default red and blue in ggplot. Set the second argument `labels` equal to `c("Did not vote", "Voted")`. 

```{r shaming21, exercise = TRUE}

```

```{r shaming21-hint-1, eval = FALSE}
... +
  scale_color_manual(values = c("...", "..."), labels = c("...", "..."))
```

###

Just as you mapped to `color` instead of `fill`, you must use `scale_color_manual` in place of `scale_fill_manual`.

### Exercise 22

Adjust the feel of your graph by adding `theme_clean()`. Finally, add labels to your graph. Use `color` rather than `fill` as we have done above. Pay particular attention to how the y-axis label and subtitle should change compared to the previous plot. 

```{r shaming22, exercise = TRUE}

```

```{r shaming22-hint, eval = FALSE}
  ... +
  labs(title = "BMI and Days Depressed",
       subtitle = "...", 
       x = "BMI", 
       y = "...", 
       color = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_clean()

```

Reminder: This is what your plot should look like.

```{r shaming22-answer}
shaming_p3
```

## Harvard Q-Guide
###

The `qscores` data set includes information about 748 courses at Harvard during the 2018-2019 school year, including their department, student enrollment, average time spent on homework, and the average student rating of the course.

### 

Let's create the following plot

```{r make-qscores1}
qscores_p1 <- qscores %>% 
 mutate(enrollment_groups = case_when(enrollment >= 16 & enrollment < 30 ~ "16-30",
            enrollment >= 30 &  enrollment < 50  ~ "30-50",
            enrollment >= 50 & enrollment < 100 ~ "50-100",
            enrollment >= 100 ~ "100+")) %>% 
  mutate(enrollment_groups = factor(enrollment_groups,
                                    levels = c("16-30", "30-50", "50-100", "100+"))) %>% 
  mutate(introduction = str_detect(name, "Introduction")) %>% 
  select(rating, enrollment_groups, introduction) %>% 
  ggplot(aes(rating, fill = introduction)) +
  geom_histogram(position = "identity", bins = 30) +
  facet_wrap(~ enrollment_groups) +
  coord_cartesian(xlim = c(1, 5)) +
  labs(title = "Ratings Distribution by Enrollment",
       subtitle = 'The largest classes have the greatest proportion of
"Introduction" classes.',
       x = "Rating",
       y = "Count",
       caption = "Harvard College",
       fill = '"Introduction" in Course Title') +


qscores_p1
```

### Exercise 1

Run `c(min(qscores$enrollment), mean(qscore$enrollment), max(qscores$enrollment))` to see the minimum and maximum enrollment value in this data. Run the equivalent command for the ratings of the classs.

```{r qscores1, exercise = TRUE}

```

###

Notice how much closer the mean rating is to the maximum than the minimum. 

### Exercise 2

Let's create a column that groups the classes into four different groups based on enrollment size. Use `mutate()` to create a new column called `enrollment_groups`. Set `enrollment_groups` equal to the function `case_when()`, which can take multiple arguments of the syntax `enrollment >= 16 & enrollment < 30 ~ "16-30"`, in which the part left of the `~` is the condition, and the part right of the `~` is the result when the condition is meant. Using this example as the first, create four groups, named "16-30", "30-50", "50-100", and "100+". 

```{r qscores2, exercise = TRUE}

```

```{r qscores2-hint-1, eval = FALSE}
... %>% 
mutate(enrollment_groups = case_when(enrollment >= 16 & enrollment < 30 ~ "16-30",
            ...")
```

```{r qscores2-hint-2, eval = FALSE}
... %>% 
  mutate(enrollment_groups = case_when(enrollment >= 16 & enrollment < 30 ~ "16-30",
            ... >= ... &  ... < ...  ~ "30-50",
            ... >= ... & ... < ... ~ "50-100",
            ... >= ... ~ "100+")
```

###

If you  forget the `=` in `>=` you may accidentally exclude data.

### Exercise 3

Recall our first two graphs for the NHANES data. When we faceted, the `depressed` facets were automatically put in order from least to greatest (None, Several, Most) without any input from us. By default, ggplot defaults to alphanumeric order, but because `depressed` was a factor its variables already had an order which overrode ggplot's default. If we were to facet by `enrollment_groups` with the default, `100+` would precede `16-30` in alphanumeric order. To do this, we must make `enrollment_groups` a factor. 

###

Use `mutate` to change the column `enrollment_groups` into a column of the same name, but with factor variables. Set `enrollment_groups` equal to `factor()`. Within `factor()`, the first argument to be the column we want to make a factor, the second argument is `levels` which should be set equal to the four different enrollment group names in the order in which we want them to appear, `c("16-30", "30-50", "50-100", "100+")`. 

```{r qscores3, exercise = TRUE}

```

```{r qscores3-hint-1, eval = FALSE}
... %>% 
 mutate(enrollment_groups = factor(...,
                                    levels = ...))
```

```{r qscores3-hint-2, eval = FALSE}
... %>% 
 mutate(enrollment_groups = factor(enrollment_groups,
                                    levels = c("16-30", "30-50", "50-100", "100+")))
```

###

Levels are always identical to the data contained within the column. 

### Exercise 4

Let's create a column that is `TRUE` whenever a course has `"Introduction"` in its title. Use `mutate()` to create a new column, called `introduction` and set it equal to the function str_detect(). The first argument should be the column through which you want to search and the second should be the pattern for which you are searching. 

```{r qscores4, exercise = TRUE}

```

```{r qscores4-hint-1, eval = FALSE}
... %>% 
  mutate(... = str_detect(name, "Introduction"))
```

### 

`str_detect` only has this function, to detect the presence or absence of a string by returning `TRUE` or `FALSE`. 

### Exercise 5

Select the columns relevant for our plot `rating`, `enrollment_groups`, and `introduction`. 

```{r qscores5, exercise = TRUE}

```

```{r qscores5-hint-1, eval = FALSE}  
... %>% 
select(..., ..., ...)
```

### Exercise 6

Continue your pipe with `ggplot()`. Add the layer `geom_histogram()`. Map `age` to the x-axis, and `introduction` to `fill`.

```{r qscores6, exercise = TRUE}

```

```{r qscores6-hint-1, eval = FALSE}
... %>% 
  ggplot(data = ..., aes(x = ..., 
                        fill = ...)) +
  geom_histogram()
```

### 

Remember that histogram has a default `y` which are the counts it tabulates for each bin from our data. 

### Exercise 7

Within geom_histogram, set the argument `position` equal to "identity" and set the argument `bins` = 30. 

```{r qscores7, exercise = TRUE}

```

```{r qscores7-hint-1, eval = FALSE}
... %>% 
  geom_histogram(position = "identity", alpha =  ..., 
                        bins = ...)) 
```

###

For histogram and bar plots, `position` is by default "stacked", which stacks different colors of the same x value on top of one another. `position` being equal to "identity", makes it so that different colors overlap, and that both can be seen when the opacity of the colors is increased. 

### Exercise 8

Add the layer `facet_wrap()` to facet the histogram by `enrollment_groups`. 

```{r qscores8, exercise = TRUE}

```

```{r qscores8-hint-1, eval = FALSE}
Within facet_wrap(), remember to put a ~ before the variable you want to facet by.
```

```{r qscores8-hint-2, eval = FALSE}
... + 
  facet_wrap(...) 
```

### Exercise 9

Add the layer `coord_cartesian` and  use the argument to limit the x-axis domain to a minimum of 1 and a maximum of 5. 

```{r qscores9, exercise = TRUE}

```

```{r qscores9-hint-1, eval = FALSE}
... +
  coord_cartesian(xlim = c(...,...))
```

### Exercise 10

Adjust the feel of the graph by adding the theme `theme_clean()`. To finish your plot, use `labs()` to give the graph a title, subtitle, axis labels, legend heading, and caption.

```{r qscores10, exercise = TRUE}

```

```{r qscores10-hint-1, eval = FALSE}
labs(... ,
     fill = "...",
     ...)
```

Reminder: This is what your plot should look like.

```{r qscores10-answer}
qscores_p1
```

### Exercise 11

Let's make the following plot, using density plots to visualize the same data.

```{r make-qscores2}
qscores_p2 <- qscores %>% 
 mutate(enrollment_groups = case_when(enrollment >= 16 & enrollment < 30 ~ "16-30",
            enrollment >= 30 &  enrollment < 50  ~ "30-50",
            enrollment >= 50 & enrollment < 100 ~ "50-100",
            enrollment >= 100 ~ "100+")) %>% 
  mutate(enrollment_groups = factor(enrollment_groups, levels = c("16-30", "30-50", "50-100", "100+"))) %>% 
  mutate(introduction = str_detect(name, "Introduction")) %>% 
  select(rating, enrollment_groups, introduction) %>% 
  ggplot(aes(rating, fill = introduction)) +
  geom_density(alpha = 0.5, position = "identity") + 
  facet_wrap(~ enrollment_groups) +
  coord_cartesian(xlim = c(1, 5)) +
  theme_classic() +
  labs(title = "Ratings Distribution by Enrollment", 
       subtitle = '"Introduction" classes have lower ratings than other classes',
       x = "Rating", 
       y = "Density",
       caption = "Harvard College", 
       fill = '"Introduction" in Course Title')

qscores_p2
```

###

We have provided you with the beginning of code for the last plot. Continue your pipe with `ggplot()`. Add the layer `geom_density()`. Map `rating` to the x-axis, and `introduction` to `fill`. Within `geom_density()`, set `alpha` equal to 0.5.

```{r qscores11, exercise = TRUE}
qscores_p2 <- qscores %>% 
 mutate(enrollment_groups = case_when(enrollment >= 16 & enrollment < 30 ~ "16-30",
            enrollment >= 30 &  enrollment < 50  ~ "30-50",
            enrollment >= 50 & enrollment < 100 ~ "50-100",
            enrollment >= 100 ~ "100+")) %>% 
  mutate(enrollment_groups = factor(enrollment_groups, levels = c("16-30", "30-50", "50-100", "100+"))) %>% 
  mutate(introduction = str_detect(name, "Introduction")) %>% 
  select(rating, enrollment_groups, introduction) %>% 
```

```{r qscores11-hint, eval = FALSE}
... %>% 
  ggplot(aes(..., fill = ...)) +
  geom_density(alpha = ...) 
```

### Exercise 12

Copy and paste the code above. Add the layer `facet_wrap()` to facet the histogram by `enrollment_groups()`. Add the layer `coord_cartesian` and  use the argument to limit the x-axis domain to a minimum of 1 and a maximum of 5. 

```{r qscores12, exercise = TRUE}

```

```{r qscores12-hint-1, eval = FALSE}
Within facet_wrap(), remember to put a ~ before the variable you want to facet by.
```

```{r qscores12-hint-2, eval = FALSE}
... +
  coord_cartesian(xlim = c(...,...))
```

### Exercise 13

Adjust the feel of your graph by adding `theme_clean()`. Finally, add labels to your graph. Pay particular attention to how the y-axis label and subtitle should change compared to the previous plot. 

```{r qscores13, exercise = TRUE}

```

```{r qscores13-hint, eval = FALSE}
  ... +
  labs(title = "BMI and Days Depressed",
       subtitle = "...", 
       x = "BMI", 
       y = "...", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_clean()

```

Reminder: This is what your plot should look like.

```{r qscores13-answer}
qscores_p2
```

###

### Exercise 14

Let's make the following plot, using another `ggdist` function, `stat_halefeye` to visualize the same data with both the distributions (as in `stat_slab`) and plot intervals. 

```{r make-qscores3}
qscores_p3 <- qscores %>% 
 mutate(enrollment_groups = case_when(enrollment >= 16 & enrollment < 30 ~ "16-30",
            enrollment >= 30 &  enrollment < 50  ~ "30-50",
            enrollment >= 50 & enrollment < 100 ~ "50-100",
            enrollment >= 100 ~ "100+")) %>% 
  mutate(enrollment_groups = factor(enrollment_groups, 
                                    levels = c("16-30", "30-50", "50-100", "100+"))) %>% 
  mutate(introduction = str_detect(name, "Introduction")) %>% 
  select(rating, enrollment_groups, introduction) %>% 
  ggplot(aes(rating, enrollment_groups, fill = introduction, color = introduction)) +
  stat_halfeye(alpha  =  0.5) + 
  coord_cartesian(xlim = c(2.7, 5)) +
    theme_classic() +
  labs(title = "Ratings Distribution by Enrollment", 
       subtitle = 'Class ratings generally decrease as in enrollment increases,
though this is not the case with introductory courses.',
x = "Rating", 
y = "Entollment",
caption = "Harvard College", 
fill = '"Introduction" in Course Title', 
color = '"Introduction" in Course Title') 

qscores_p3
```

###

We have provided you with the beginning of code for the last plot. Continue your pipe with `ggplot()`. Add the layer `geom_density()`. Map `rating` to the x-axis, `enrollment_groups` to the y-axis, `introduction` to `fill`, **and** `introduction` to **color**. Within `geom_density()`, set `alpha` equal to 0.5.

```{r qscores14, exercise = TRUE}
qscores_p2 <- qscores %>% 
 mutate(enrollment_groups = case_when(enrollment >= 16 & enrollment < 30 ~ "16-30",
            enrollment >= 30 &  enrollment < 50  ~ "30-50",
            enrollment >= 50 & enrollment < 100 ~ "50-100",
            enrollment >= 100 ~ "100+")) %>% 
  mutate(enrollment_groups = factor(enrollment_groups, levels = c("16-30", "30-50", "50-100", "100+"))) %>% 
  mutate(introduction = str_detect(name, "Introduction")) %>% 
  select(rating, enrollment_groups, introduction) %>% 
```

```{r qscores14-hint, eval = FALSE}
... %>% 
  ggplot(aes(..., ..., fill = ..., )) +
  stat_halfeye(alpha = ...) 
```

### 

We map `introduction` to both `fill` and `color` since our graph includes both a filled shape and a line. 

### Exercise 15

Add the layer `coord_cartesian` and  use the argument to limit the x-axis domain to a minimum of 2.7 and a maximum of 5, so that we can better focus on the peaks of the distributions. 

```{r qscores15, exercise = TRUE}

```

```{r qscores15-hint, eval = FALSE}
... +
  coord_cartesian(xlim = c(...,...))
```

### Exercise 16

Adjust the feel of your graph by adding `theme_clean()`. Finally, add labels to your graph. Pay particular attention to how the y-axis label and subtitle should change compared to the previous plot. 

```{r qscores16, exercise = TRUE}

```

```{r qscores16-hint, eval = FALSE}
  ... +
  labs(title = "BMI and Days Depressed",
       subtitle = "...", 
       x = "BMI", 
       y = "...", 
       fill = "Sex",
       caption = "National Health and Nutrition Examination Survey") +
  theme_clean()

```

Reminder: This is what your plot should look like.

```{r qscores16-answer}
qscores_p3
```


## Kenya Voter Registration Experiment
###

Let's create the following plot.

```{r make-kenya1}
kenya_p1 <- kenya %>% 
  mutate(poverty_groups = case_when(poverty >= .18 & poverty < .35 ~ "1st Quartile",
            poverty >= .35 &  poverty < .43  ~ "2nd Quartile",
            poverty >= .43 & poverty < .49 ~ "3rd Quartile",
            poverty >= .49 ~ "4th Quartile")) %>% 
  mutate(poverty_groups = factor(poverty_groups, 
                                    levels = c("1st Quartile", "2nd Quartile", 
                                    "3rd Quartile", "4th Quartile"), 
                                    labels = c("1st Quartile (Richest)", "2nd Quartile", 
                                    "3rd Quartile", "4th Quartile (Poorest)"))) %>% 
  mutate(age_groups = case_when(mean_age < 41.5  ~ "1st Half",
                                     mean_age >= 41.5  ~ "2nd Half")) %>% 
  select(reg_byrv13, treatment, poverty_groups, age_groups) %>% 
  drop_na() %>%
  ggplot(aes(reg_byrv13, fill = age_groups)) +
  geom_histogram(bins = 500, position = "stack") +
  facet_wrap(~ poverty_groups) +
  coord_cartesian(xlim = c(.005, .15), ylim = c(0, 160)) +
  scale_x_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = c("#F8766D", "#00BFC4"), labels = c("Younger Half", "Older Half")) +
  theme_classic() +
  labs(title = "Distribution of New Registered Voters by Poverty and Age Groups",
       subtitle = "The poorest districts have fewer zero and near-zero percent 
increases and more districts of unusually high increase",
       x = "Percent of New Registered Voters", 
       y = "Count", 
       fill = "Mean Age") 

kenya_p1
```


###

Let's create the following plot.

```{r make-kenya2}
kenya_p2 <- kenya %>% 
  mutate(poverty_groups = case_when(poverty >= .18 & poverty < .35 ~ "1st Quartile",
            poverty >= .35 &  poverty < .43  ~ "2nd Quartile",
            poverty >= .43 & poverty < .49 ~ "3rd Quartile",
            poverty >= .49 ~ "4th Quartile")) %>% 
  mutate(poverty_groups = factor(poverty_groups, 
                                       levels = c("1st Quartile", "2nd Quartile", 
                                                  "3rd Quartile", "4th Quartile"),
                                       labels = c("1st Quartile (Richest)", "2nd Quartile", 
                                                  "3rd Quartile", "4th Quartile (Poorest)"))) %>% 
  mutate(age_groups = case_when(mean_age < 41.5  ~ "1st Half",
                                     mean_age >= 41.5  ~ "2nd Half")) %>% 
  select(reg_byrv13, treatment, poverty_groups, age_groups) %>% 
  drop_na() %>%
  ggplot(aes(reg_byrv13, fill = age_groups)) +
  geom_density(position = "identity", alpha = 0.5, color = NA) +
  facet_wrap(~ poverty_groups) + 
  coord_cartesian(xlim = c(0, .25)) +
  scale_x_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = c("#F8766D", "#00BFC4"), labels = c("Younger Half", "Older Half")) +
  labs(title = "Distribution of New Registered Voters by Poverty and Age Groups",
       subtitle = "Among the poorest districts the discrepancy between younger
districts and older districts is least",
       x = "Percent of New Registered Voters", 
       y = "Density", 
       fill = "Mean Age") +
  theme_classic()

kenya_p2
```

Let's create the following plot.

```{r make-kenya3 }
kenya_p3 <- kenya %>% 
  mutate(poverty_groups = case_when(poverty >= .18 & poverty < .35 ~ "1st Quartile",
            poverty >= .35 &  poverty < .43  ~ "2nd Quartile",
            poverty >= .43 & poverty < .49 ~ "3rd Quartile",
            poverty >= .49 ~ "4th Quartile")) %>% 
  mutate(age_groups = case_when(mean_age < 41.5  ~ "1st Half",
                                     mean_age >= 41.5  ~ "2nd Half")) %>% 
  mutate(poverty_groups = factor(poverty_groups, 
                                       levels = c("1st Quartile", "2nd Quartile", 
                                                  "3rd Quartile", "4th Quartile"),
                                       labels = c("1st Quartile (Richest)", "2nd Quartile", 
                                                  "3rd Quartile", "4th Quartile (Poorest)"))) %>%
  group_by(poverty_groups, age_groups) %>% 
  select(reg_byrv13, treatment, poverty_groups, age_groups) %>% 
  drop_na() %>%
  ggplot(aes(reg_byrv13, fill = poverty_groups, y = age_groups)) +
  stat_slab(position = "dodge") +
  coord_cartesian(xlim = c(0, .25)) +
  scale_x_continuous(labels = scales::percent_format()) +
  scale_y_discrete(labels = c("Younger Half", "Older Half")) +
  labs(title = "Distribution of New Registered Voters by Poverty and Age Groups",
       subtitle = "Poorer districts have more higher increases in younger districts and 
even more in older districts",
       x = "Percent of New Registered Voters", 
       y = "", 
       color = "Poverty",
       fill = "Poverty") +
  theme_classic()

kenya_p3
```




